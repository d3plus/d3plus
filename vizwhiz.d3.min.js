(function(){var vizwhiz=window.vizwhiz||{};vizwhiz.version="0.0.1";vizwhiz.dev=false;window.vizwhiz=vizwhiz;vizwhiz.timing=600;vizwhiz.tooltip={};vizwhiz.utils={};vizwhiz.evt={};vizwhiz.ie=false;if(Modernizr.touch){vizwhiz.evt.click="touchend";vizwhiz.evt.down="touchstart";vizwhiz.evt.up="touchend";vizwhiz.evt.over="touchstart";vizwhiz.evt.out="touchend";vizwhiz.evt.move="touchmove"}else{vizwhiz.evt.click="click";vizwhiz.evt.down="mousedown";vizwhiz.evt.up="mouseup";if(vizwhiz.ie){vizwhiz.evt.over="mouseenter";vizwhiz.evt.out="mouseleave"}else{vizwhiz.evt.over="mouseover";vizwhiz.evt.out="mouseout"}vizwhiz.evt.move="mousemove"}vizwhiz.utils.format_num=function(val,percent,sig_figs,abbrv){if(Math.abs(val-1e-16)<1e-10){val=0}if(percent){val=d3.format("."+sig_figs+"p")(val)}else if(abbrv){var symbol=d3.formatPrefix(val).symbol;symbol=symbol.replace("G","B");val=d3.formatPrefix(val).scale(val);val=parseFloat(d3.format("."+sig_figs+"g")(val));val=val+" "+symbol}else{val=d3.format(",."+sig_figs+"f")(val)}return val};vizwhiz.utils.color_scale=d3.scale.category20();vizwhiz.utils.rand_color=function(){var rand_int=Math.floor(Math.random()*20);return vizwhiz.utils.color_scale(rand_int)};vizwhiz.utils.text_color=function(color){var hsl=d3.hsl(color),light="#fff",dark="#333";if(hsl.l>.65)return dark;else if(hsl.l<.48)return light;return hsl.h>35&&hsl.s>=.3&&hsl.l>=.41?dark:light};vizwhiz.utils.darker_color=function(color){var hsl=d3.hsl(color);if(hsl.s>.9)hsl.s=.9;if(hsl.l>.4)hsl.l=.4;return hsl.toString()};vizwhiz.utils.uniques=function(data,value){return d3.nest().key(function(d){return d[value]}).entries(data).reduce(function(a,b,i,arr){return a.concat(parseInt(b["key"]))},[])};vizwhiz.utils.merge=function(obj1,obj2){var obj3={};for(var attrname in obj1){obj3[attrname]=obj1[attrname]}for(var attrname in obj2){obj3[attrname]=obj2[attrname]}return obj3};vizwhiz.utils.rename_key_value=function(obj){if(obj.values&&obj.values.length){return{name:obj.key.split("|")[1],id:obj.key.split("|")[0],children:obj.values.map(function(obj){return vizwhiz.utils.rename_key_value(obj)})}}else if(obj.values){return obj.values}else{return obj}};vizwhiz.utils.wordwrap=function(params){var parent=params.parent,padding=params.padding?params.padding:10,width=params.width?params.width-padding*2:2e4,height=params.height?params.height:2e4,resize=params.resize,font_max=params.font_max?params.font_max:40,font_min=params.font_min?params.font_min:8;if(params.text instanceof Array)wrap(String(params.text.shift()).split(/[\s-]/));else wrap(String(params.text).split(/[\s-]/));function wrap(words){if(resize){var size=font_max;d3.select(parent).attr("font-size",size);d3.select(parent).selectAll("tspan").remove();for(var i=0;i<words.length;i++){if(words.length==1)var t=words[i];else var t=words[i]+"...";d3.select(parent).append("tspan").attr("x",0).text(t)}if(parent.getBBox().width>width)size=size*(width/parent.getBBox().width);if(size<font_min){d3.select(parent).selectAll("tspan").remove();if(typeof params.text=="string"||params.text.length==0)return;else wrap(String(params.text.shift()).split(/[\s-]/));return}d3.select(parent).attr("font-size",size);flow();if(parent.childNodes.length*parent.getBBox().height>height){var temp_size=size*(height/(parent.childNodes.length*parent.getBBox().height));if(temp_size<font_min)size=font_min;else size=temp_size;d3.select(parent).attr("font-size",size)}else finish()}flow();truncate();finish();function flow(){d3.select(parent).selectAll("tspan").remove();var tspan=d3.select(parent).append("tspan").attr("x",parent.getAttribute("x")).text(words[0]);for(var i=1;i<words.length;i++){tspan.text(tspan.text()+" "+words[i]);if(tspan.node().getComputedTextLength()>width){tspan.text(tspan.text().substr(0,tspan.text().lastIndexOf(" ")));tspan=d3.select(parent).append("tspan").attr("x",parent.getAttribute("x")).text(words[i])}}}function truncate(){var cut=false;while(parent.childNodes.length*parent.getBBox().height>height&&parent.lastChild&&!cut){parent.removeChild(parent.lastChild);if(parent.childNodes.length*parent.getBBox().height<height&&parent.lastChild)cut=true}if(cut){tspan=parent.lastChild;words=d3.select(tspan).text().split(/[\s-]/);var last_char=words[words.length-1].charAt(words[words.length-1].length-1);if(last_char==","||last_char==";"||last_char==":")words[words.length-1]=words[words.length-1].substr(0,words[words.length-1].length-1);d3.select(tspan).text(words.join(" ")+"...");if(tspan.getComputedTextLength()>width){if(words.length>1)words.pop(words.length-1);last_char=words[words.length-1].charAt(words[words.length-1].length-1);if(last_char==","||last_char==";"||last_char==":")words[words.length-1].substr(0,words[words.length-1].length-2);d3.select(tspan).text(words.join(" ")+"...")}}}}function finish(){d3.select(parent).selectAll("tspan").attr("dy",d3.select(parent).style("font-size"));return}};vizwhiz.utils.drop_shadow=function(defs){var drop_shadow_filter=defs.append("filter").attr("id","dropShadow").attr("filterUnits","userSpaceOnUse").attr("width","100%").attr("height","100%");drop_shadow_filter.append("feGaussianBlur").attr("in","SourceAlpha").attr("stdDeviation",2);drop_shadow_filter.append("feOffset").attr("dx",1).attr("dy",1).attr("result","offsetblur");var feMerge=drop_shadow_filter.append("feMerge");feMerge.append("feMergeNode");feMerge.append("feMergeNode").attr("in","SourceGraphic")};vizwhiz.tooltip.create=function(params){params.width=params.width?params.width:200;params.id=params.id?params.id:"default";params.html=params.html?params.html:null;params.size=params.fullscreen?"large":"small";params.offset=params.offset?params.offset:0;params.arrow_offset=params.arrow?10:0;params.mouseevents=params.mouseevents===undefined?true:params.mouseevents;params.x=params.x?params.x:0;params.y=params.y?params.y:0;params.anchor={};if(params.fullscreen){params.anchor.x="center";params.anchor.y="center";params.x=window.innerWidth/2;params.y=window.innerHeight/2}else if(params.align){var a=params.align.split(" ");params.anchor.y=a[0];if(a[1])params.anchor.x=a[1];else params.anchor.x="center"}else{params.anchor.x="center";params.anchor.y="bottom"}var title_width=params.fullscreen&&params.html?window.innerWidth*.75-18:params.width-18;if(params.fullscreen){var curtain=d3.select("body").append("div").attr("class","vizwhiz_tooltip_curtain").on(vizwhiz.evt.click,function(){vizwhiz.tooltip.remove(params.id)})}var tooltip=d3.select("body").append("div").datum(params).attr("id","vizwhiz_tooltip_id_"+params.id).attr("class","vizwhiz_tooltip vizwhiz_tooltip_"+params.size);if(params.title||params.description||params.icon){var header=tooltip.append("div").attr("class","vizwhiz_tooltip_header").style("color",vizwhiz.utils.text_color(params.color));if(params.color){header.style("background-color",params.color)}if(!params.data&&!params.footer){header.style("-webkit-border-radius","2px").style("-moz-border-radius","2px").style("border-radius","2px")}if(params.id!="default"&&params.size=="small"){var title_id=header.append("div").attr("class","vizwhiz_tooltip_id").text(params.id);title_width-=title_id.node().offsetWidth+6}else if(params.fullscreen){var close=header.append("div").attr("class","vizwhiz_tooltip_close").text("x").on(vizwhiz.evt.click,function(){vizwhiz.tooltip.remove(params.id)})}}if(params.fullscreen&&params.html){tooltip.style("height",window.innerHeight*.75+"px").style("width",window.innerWidth*.75+"px");var body=tooltip.append("div").attr("class","vizwhiz_tooltip_body").style("width",params.width+"px")}else{if(params.width=="auto")var w="auto";else var w=params.width+"px";var body=tooltip.style("width",w)}if(!params.mouseevents){tooltip.style("pointer-events","none")}if(params.arrow){var arrow=body.append("div").attr("class","vizwhiz_tooltip_arrow")}if(params.icon){var title_icon=header.append("div").attr("class","vizwhiz_tooltip_icon").style("background-image","url("+params.icon+")");title_width-=title_icon.node().offsetWidth}if(params.title){var title=header.append("div").attr("class","vizwhiz_tooltip_title").style("width",title_width+"px").text(params.title)}if(params.description){var description=header.append("div").attr("class","vizwhiz_tooltip_description").style("width",title_width+"px").text(params.description);if(params.icon){description.style("margin-left",title_icon.node().offsetWidth+3+"px")}}if(params.data){var data_container=body.append("div").attr("class","vizwhiz_tooltip_data_container");params.data.forEach(function(d){var block=data_container.append("div").attr("class","vizwhiz_tooltip_data_block").text(d.name);if(d.highlight){block.attr("class","vizwhiz_tooltip_data_block vizwhiz_tooltip_data_block_highlight")}var format=d.format?d.format:",f";if(typeof format=="string"&&typeof d.value=="number"){var value=d3.format(format)(d.value)}else if(typeof format=="function"&&typeof d.value=="number"){var value=format(d)}else{var value=d.value}block.append("div").attr("class","vizwhiz_tooltip_data_value").text(value)});d3.select(".vizwhiz_tooltip_data_block").style("margin-top","0px");if(params.html&&!params.fullscreen){data_container.html(data_container.html()+params.html)}}if(params.footer){var footer=body.append("div").attr("class","vizwhiz_tooltip_footer").html(params.footer)}params.height=tooltip.node().offsetHeight;if(params.html){if(params.fullscreen){var h=params.height-header.node().offsetHeight-14;tooltip.append("div").attr("class","vizwhiz_tooltip_html").style("width",tooltip.node().offsetWidth-params.width-14+"px").style("height",h+"px").html(params.html)}}params.width=tooltip.node().offsetWidth;if(params.anchor.y!="center")params.height+=params.arrow_offset;else params.width+=params.arrow_offset;if(params.data){var h=params.height-8;if(header)h-=header.node().offsetHeight;if(footer)h-=footer.node().offsetHeight;data_container.style("max-height",h+"px")}vizwhiz.tooltip.move(params.x,params.y,params.id)};vizwhiz.tooltip.arrow=function(arrow){arrow.style("background-color",function(d){if((d.flip||!d.data&&!d.footer)&&d.anchor.y!="center"||d.anchor.y=="center"&&!d.data&&!d.footer&&d.color){return d.color}else{return"#ddd"}}).style("bottom",function(d){if(d.anchor.y!="center"&&!d.flip)return"-9px";else return"auto"}).style("top",function(d){if(d.anchor.y!="center"&&d.flip)return"-9px";else if(d.anchor.y=="center")return"50%";else return"auto"}).style("left",function(d){if(d.anchor.y=="center"&&d.flip)return"-9px";else if(d.anchor.y!="center")return"50%";else return"auto"}).style("right",function(d){if(d.anchor.y=="center"&&!d.flip)return"-9px";else return"auto"}).style("border-color",function(d){if(d.anchor.y=="center"){if(d.flip)return"border-color","transparent transparent #888 #888";else return"#888 #888 transparent transparent"}else{if(d.flip)return"border-color","#888 transparent transparent #888";else return"transparent #888 #888 transparent"}}).style("margin-left",function(d){if(d.anchor.y=="center"){return"auto"}else{if(d.anchor.x=="left"){var arrow_x=-d.width/2+d.arrow_offset/2-1}else if(d.anchor.x=="right"){var arrow_x=d.width/2-d.arrow_offset*2-2}else{var arrow_x=-9}if(d.cx-d.width/2-d.arrow_offset<arrow_x){arrow_x=d.cx-d.width/2-d.arrow_offset;if(arrow_x<4-d.width/2)arrow_x=4-d.width/2}else if(-(window.innerWidth-d.cx-d.width/2+d.arrow_offset)>arrow_x){var arrow_x=-(window.innerWidth-d.cx-d.width/2+d.arrow_offset);if(arrow_x>d.width/2-22)arrow_x=d.width/2-22}return arrow_x+"px"}}).style("margin-top",function(d){if(d.anchor.y!="center"){return"auto"}else{if(d.anchor.y=="top"){var arrow_y=-d.height/2+d.arrow_offset/2-1}else if(d.anchor.y=="bottom"){var arrow_y=d.height/2-d.arrow_offset*2-2}else{var arrow_y=-9}if(d.cy-d.height/2-d.arrow_offset<arrow_y){arrow_y=d.cy-d.height/2-d.arrow_offset;if(arrow_y<4-d.height/2)arrow_y=4-d.height/2}else if(-(window.innerHeight-d.cy-d.height/2+d.arrow_offset)>arrow_y){var arrow_y=-(window.innerHeight-d.cy-d.height/2+d.arrow_offset);if(arrow_y>d.height/2-22)arrow_y=d.height/2-22}return arrow_y+"px"}})};vizwhiz.tooltip.remove=function(id){if(id)d3.select("div#vizwhiz_tooltip_id_"+id).remove();else d3.selectAll("div.vizwhiz_tooltip").remove();d3.selectAll("div.vizwhiz_tooltip_curtain").remove()};vizwhiz.tooltip.move=function(x,y,id){if(!id)var tooltip=d3.select("div#vizwhiz_tooltip_id_default");else var tooltip=d3.select("div#vizwhiz_tooltip_id_"+id);if(tooltip.node()){var d=tooltip.datum();d.cx=x;d.cy=y;if(!d.fixed){if(d.anchor.y!="center"){if(d.anchor.x=="left"){d.x=d.cx-d.arrow_offset-4}else if(d.anchor.x=="center"){d.x=d.cx-d.width/2}else if(d.anchor.x=="right"){d.x=d.cx-d.width+d.arrow_offset+2}if(d.anchor.y=="top"){d.flip=d.cy+d.height+d.offset<=window.innerHeight}else if(d.anchor.y=="bottom"){d.flip=d.cy-d.height-d.offset<0}if(d.anchor.y=="center"){d.flip=false;d.y=d.cy-d.height/2}else if(d.flip){d.y=d.cy+d.offset+d.arrow_offset}else{d.y=d.cy-d.height-d.offset}}else{if(d.anchor.y=="top"){d.y=d.cy-d.arrow_offset-4}else if(d.anchor.y=="center"){d.y=d.cy-d.height/2}else if(d.anchor.y=="right"){d.y=d.cy-d.height+d.arrow_offset+2}if(d.anchor.x=="left"){d.flip=d.cx+d.width+d.offset<=window.innerWidth}else if(d.anchor.x=="right"){d.flip=d.cx-d.width-d.offset<0}if(d.anchor.x=="center"){d.flip=false;d.x=d.cx-d.width/2}else if(d.flip){d.x=d.cx+d.offset+d.arrow_offset}else{d.x=d.cx-d.width-d.offset}}if(d.x<0){d.x=0}else if(d.x+d.width>window.innerWidth){d.x=window.innerWidth-d.width}if(d.y<0){d.y=0}else if(d.y+d.height>window.innerHeight){d.y=window.innerHeight-d.height}}else{var th=window.innerHeight-5-d.y;tooltip.style("max-height",th+"px");if(d.data||d.html){if(tooltip.select(".vizwhiz_tooltip_header").node()){th-=tooltip.select(".vizwhiz_tooltip_header").node().offsetHeight}tooltip.select(".vizwhiz_tooltip_data_container").style("max-height",th-6+"px")}}tooltip.style("top",d.y+"px").style("left",d.x+"px");if(d.arrow){tooltip.select(".vizwhiz_tooltip_arrow").call(vizwhiz.tooltip.arrow)}}};vizwhiz.viz=function(){var vars={active_var:"active",arc_angles:{},arc_inners:{},arc_sizes:{},attrs:null,boundries:null,click_function:function(){return null},connections:null,coords:null,csv_columns:null,data:null,data_source:null,depth:null,donut:true,filter:[],filtered_data:null,group_bgs:true,grouping:"name",highlight:null,id_var:"id",init:true,keys:[],labels:true,layout:"value",links:null,map:{coords:null,style:{land:{fill:"#f9f4e8"},water:{fill:"#bfd1df"}}},margin:{top:0,right:0,bottom:0,left:0},name_array:null,nesting:[],nesting_aggs:{},nodes:null,number_format:function(d){if(typeof d==="number")return d3.format(",f")(d);else return d3.format(",f")(d.value)},order:"asc",projection:d3.geo.mercator(),solo:[],sort:"total",source_text:null,spotlight:true,sub_title:null,svg_height:window.innerHeight,svg_width:window.innerWidth,text_format:function(d){return d},text_var:"name",tiles:true,title:null,tooltip_info:[],total_bar:false,type:"tree_map",value_var:"value",xaxis_domain:null,xaxis_var:null,yaxis_domain:null,yaxis_var:null,year:null,years:null,year_var:"year",zoom_behavior:d3.behavior.zoom()};var nodes,links;chart=function(selection){selection.each(function(data){if(vizwhiz.dev)console.log("Initializing App");vizwhiz.tooltip.remove();vars.parent=d3.select(this);vars.svg=vars.parent.selectAll("svg").data([data]);vars.svg_enter=vars.svg.enter().append("svg").attr("width",vars.svg_width).attr("height",vars.svg_height).style("z-index",10).style("position","absolute");vars.svg.transition().duration(vizwhiz.timing).attr("width",vars.svg_width).attr("height",vars.svg_height);if(vizwhiz.dev)console.log("Establishing Year Range and Current Year");vars.years=vizwhiz.utils.uniques(data,vars.year_var);if(!vars.year)vars.year=vars.years[vars.years.length-1];if(vizwhiz.dev)console.log("Filtering Data");vars.keys={};var filtered_data=data.filter(function(d){for(k in d){if(!vars.keys[k]){vars.keys[k]=typeof d[k]}}if(vars.xaxis_var){if(typeof d[vars.xaxis_var]=="undefined")return false}if(vars.yaxis_var){if(typeof d[vars.yaxis_var]=="undefined")return false}if(vars.spotlight&&vars.type=="pie_scatter"){if(d[vars.active_var])return false}if(vars.year&&vars.type!="stacked")return d[vars.year_var]==vars.year;return true});removed_ids=[];if(vars.solo.length||vars.filter.length){if(vizwhiz.dev)console.log("Removing Solo/Filters");filtered_data=filtered_data.filter(function(d){var check=[d[vars.id_var],d[vars.text_var]];vars.nesting.forEach(function(key){for(x in d[key]){check.push(d[key][x])}});var match=false;if(d[vars.id_var]!=vars.highlight||vars.type!="rings"){if(vars.solo.length){check.forEach(function(c){if(vars.solo.indexOf(c)>=0)match=true});if(match)return true;removed_ids.push(d[vars.id_var]);return false}else{check.forEach(function(c){if(vars.filter.indexOf(c)>=0)match=true});if(match){removed_ids.push(d[vars.id_var]);return false}return true}}else{return true}})}if(["network","rings"].indexOf(vars.type)>=0){if(vars.solo.length||vars.filter.length){vars.nodes=nodes.filter(function(n){if(removed_ids.indexOf(n[vars.id_var])>=0){return false}else{return true}});vars.links=links.filter(function(l){if(removed_ids.indexOf(l.source[vars.id_var])>=0||removed_ids.indexOf(l.target[vars.id_var])>=0){return false}else{return true}})}else{vars.nodes=nodes;vars.links=links}vars.connections=get_connections(vars.links)}vars.filtered_data=filtered_data;if(!vars.total_bar){var total_val=null}else{var total_val=d3.sum(filtered_data,function(d){return d[vars.value_var]})}if(["tree_map","pie_scatter"].indexOf(vars.type)>=0){if(vizwhiz.dev)console.log("Nesting Data");vars.data=nest(filtered_data)}else if(vars.type=="stacked"){if(vizwhiz.dev)console.log("Nesting Data");var temp_data=[];vars.years.forEach(function(year){var year_data=filtered_data.filter(function(d){return d[vars.year_var]==year});year_data=nest(year_data);temp_data=temp_data.concat(year_data)});vars.data=temp_data}else if(["geo_map","network","rings"].indexOf(vars.type)>=0){vars.data={};filtered_data.forEach(function(d){vars.data[d[vars.id_var]]=d})}else{vars.data=filtered_data}vars.width=vars.svg_width;if(vizwhiz.dev)console.log("Creating Titles");vars.margin.top=0;if(vars.svg_width<300||vars.svg_height<200){vars.small=true;make_title(null,"title");make_title(null,"sub_title");make_title(null,"total_bar")}else{vars.small=false;make_title(vars.title,"title");make_title(vars.sub_title,"sub_title");make_title(total_val,"total_bar")}if(vars.margin.top>0)vars.margin.top+=3;vars.height=vars.svg_height-vars.margin.top;vars.svg_enter.append("clipPath").attr("id","clipping").append("rect").attr("width",vars.width).attr("height",vars.height);vars.svg.select("#clipping rect").transition().duration(vizwhiz.timing).attr("width",vars.width).attr("height",vars.height);vars.parent_enter=vars.svg_enter.append("g").attr("class","parent").attr("width",vars.width).attr("height",vars.height).attr("clip-path","url(#clipping)").attr("transform","translate("+vars.margin.left+","+vars.margin.top+")");vars.svg.select("g.parent").transition().duration(vizwhiz.timing).attr("width",vars.width).attr("height",vars.height).attr("transform","translate("+vars.margin.left+","+vars.margin.top+")");if(vizwhiz.dev)console.log("Building Specific App");vizwhiz[vars.type](vars)});return chart};nest=function(flat_data){var flattened=[];var nested_data=d3.nest();var levels=vars.depth?vars.nesting.slice(0,vars.nesting.indexOf(vars.depth)+1):vars.nesting;levels.forEach(function(nest_key,i){nested_data.key(function(d){return d[nest_key].id+"|"+d[nest_key].name});if(i==levels.length-1){nested_data.rollup(function(leaves){if(leaves.length==1){flattened.push(leaves[0]);return leaves[0]}to_return={name:leaves[0][nest_key].name,id:leaves[0][nest_key].id,num_children:leaves.length,num_children_active:d3.sum(leaves,function(d){return d.active})};if(leaves[0][nest_key].display_id)to_return.display_id=leaves[0][nest_key].display_id;for(key in vars.keys){if(vars.nesting_aggs[key]){to_return[key]=d3[vars.nesting_aggs[key]](leaves,function(d){return d[key]})}else{if(["color",vars.year_var].indexOf(key)>=0){to_return[key]=leaves[0][key]}else if(vars.keys[key]==="number"){to_return[key]=d3.sum(leaves,function(d){return d[key]})}}}if(vars.type!="tree_map"){levels.forEach(function(nk){to_return[nk]=leaves[0][nk]});flattened.push(to_return)}return to_return})}});nested_data=nested_data.entries(flat_data).map(vizwhiz.utils.rename_key_value);if(vars.type!="tree_map"){return flattened}return{name:"root",children:nested_data}};make_title=function(title,type){var data=title?[title]:[],font_size=type=="title"?18:13,title_position={x:vars.width/2,y:vars.margin.top};if(type=="total_bar"){data=vars.number_format(data[0]);vars.total_bar.prefix?data=vars.total_bar.prefix+data:null;vars.total_bar.suffix?data=data+vars.total_bar.suffix:null;data=[data]}var total=vars.svg.selectAll("g."+type).data(data);total.enter().append("g").attr("class",type).style("opacity",0).append("text").attr(title_position).attr("font-size",font_size).attr("fill","#333").attr("text-anchor","middle").attr("font-family","Helvetica").style("font-weight","normal").each(function(d){vizwhiz.utils.wordwrap({text:d,parent:this,width:vars.svg_width,height:vars.svg_height/8,resize:false})});total.transition().duration(vizwhiz.timing).style("opacity",1);total.select("text").transition().duration(vizwhiz.timing).attr(title_position).each(function(d){vizwhiz.utils.wordwrap({text:d,parent:this,width:vars.svg_width,height:vars.svg_height/4,resize:false})});total.exit().transition().duration(vizwhiz.timing).style("opacity",0).remove();if(total.node())vars.margin.top+=total.select("text").node().getBBox().height};get_connections=function(links){var connections={};links.forEach(function(d){if(!connections[d.source[vars.id_var]]){connections[d.source[vars.id_var]]=[]}connections[d.source[vars.id_var]].push(d.target);if(!connections[d.target[vars.id_var]]){connections[d.target[vars.id_var]]=[]}connections[d.target[vars.id_var]].push(d.source)});return connections};get_tooltip_data=function(id,length){if(!length)var length="long";if(["network","rings"].indexOf(vars.type)>=0){var tooltip_highlight=vars.active_var}else{var tooltip_highlight=vars.value_var}if(vars.tooltip_info instanceof Array)var a=vars.tooltip_info;else var a=vars.tooltip_info[length];var data=[];a.forEach(function(t){var value=find_variable(id,t);var name=vars.text_format(t);if(value){var h=t==tooltip_highlight;data.push({name:name,value:value,highlight:h,format:vars.number_format})}});return data};find_variable=function(id,variable){if(typeof id=="string"){var data=vars.filtered_data.filter(function(d){return d[vars.id_var]==id})[0]}else{var data=id}var attr=vars.attrs[id];var value=false;if(data&&data[variable])value=data[variable];else if(attr&&attr[variable])value=attr[variable];else if(variable=="color")value=vizwhiz.utils.rand_color();if(variable==vars.text_var&&value){return vars.text_format(value)}else return value};chart.active_var=function(x){if(!arguments.length)return vars.active_var;vars.active_var=x;return chart};chart.attrs=function(x){if(!arguments.length)return vars.attrs;vars.attrs=x;return chart};chart.click_function=function(x){if(!arguments.length)return vars.click_function;vars.click_function=x;return chart};chart.csv_data=function(x){if(!arguments.length){var csv_to_return=[];if(vars.csv_columns){vars.filtered_data.map(function(d){d3.keys(d).forEach(function(d_key){if(vars.csv_columns.indexOf(d_key)<0){delete d[d_key]}})})}csv_to_return.push(d3.keys(vars.filtered_data[0]));vars.filtered_data.forEach(function(d){csv_to_return.push(d3.values(d))});return csv_to_return}return chart};chart.csv_columns=function(x){if(!arguments.length)return vars.csv_columns;vars.csv_columns=x;return chart};chart.coords=function(x){if(!arguments.length)return vars.coords;vars.coords=topojson.object(x,x.objects[Object.keys(x.objects)[0]]).geometries;vars.boundries={coordinates:[[]],type:"Polygon"};vars.coords.forEach(function(v,i){v.coordinates.forEach(function(c){c.forEach(function(a){if(a.length==2)vars.boundries.coordinates[0].push(a);else{a.forEach(function(aa){vars.boundries.coordinates[0].push(aa)})}})})});return chart};chart.data_source=function(x){if(!arguments.length)return vars.data_source;vars.data_source=x;return chart};chart.depth=function(x){if(!arguments.length)return vars.depth;vars.depth=x;return chart};chart.donut=function(x){if(!arguments.length)return vars.donut;if(typeof x=="boolean")vars.donut=x;else if(x==="false")vars.donut=false;else vars.donut=true;return chart};chart.filter=function(x){if(!arguments.length)return vars.filter;if(x instanceof Array){vars.filter=x}else{if(vars.filter.indexOf(x)>-1){vars.filter.splice(vars.filter.indexOf(x),1)}else if(vars.solo.indexOf(x)>-1){vars.solo.splice(vars.solo.indexOf(x),1);vars.filter.push(x)}else{vars.filter.push(x)}}return chart};chart.group_bgs=function(x){if(!arguments.length)return vars.group_bgs;if(typeof x=="boolean")vars.group_bgs=x;else if(x==="false")vars.group_bgs=false;else vars.group_bgs=true;return chart};chart.grouping=function(x){if(!arguments.length)return vars.grouping;vars.grouping=x;return chart};chart.height=function(x){if(!arguments.length)return vars.svg_height;vars.svg_height=x;return chart};chart.highlight=function(value){if(!arguments.length)return vars.highlight;vars.highlight=value;return chart};chart.id_var=function(x){if(!arguments.length)return vars.id_var;vars.id_var=x;return chart};chart.labels=function(x){if(!arguments.length)return vars.labels;vars.labels=x;return chart};chart.layout=function(x){if(!arguments.length)return vars.layout;vars.layout=x;return chart};chart.links=function(x){if(!arguments.length)return vars.links;links=x;return chart};chart.map=function(x,style){if(!arguments.length)return vars.map;vars.map.coords=x;if(style){vars.map.style.land=style.land?style.land:map.style.land;vars.map.style.water=style.water?style.water:map.style.water}return chart};chart.name_array=function(x){if(!arguments.length)return vars.name_array;vars.name_array=x;return chart};chart.nesting=function(x){if(!arguments.length)return vars.nesting;vars.nesting=x;return chart};chart.nesting_aggs=function(x){if(!arguments.length)return vars.nesting_aggs;vars.nesting_aggs=x;return chart};chart.nodes=function(x){if(!arguments.length)return vars.nodes;nodes=x;return chart};chart.number_format=function(x){if(!arguments.length)return vars.number_format;vars.number_format=x;return chart};chart.order=function(x){if(!arguments.length)return vars.order;vars.order=x;return chart};chart.solo=function(x){if(!arguments.length)return vars.solo;if(x instanceof Array){vars.solo=x}else{if(vars.solo.indexOf(x)>-1){vars.solo.splice(vars.solo.indexOf(x),1)}else if(vars.filter.indexOf(x)>-1){vars.filter.splice(vars.filter.indexOf(x),1);vars.solo.push(x)}else{vars.solo.push(x)}}return chart};chart.sort=function(x){if(!arguments.length)return vars.sort;vars.sort=x;return chart};chart.source_text=function(x){if(!arguments.length)return vars.source_text;vars.source_text=x;return chart};chart.spotlight=function(x){if(!arguments.length)return vars.spotlight;if(typeof x=="boolean")vars.spotlight=x;else if(x==="false")vars.spotlight=false;else vars.spotlight=true;return chart};chart.sub_title=function(x){if(!arguments.length)return vars.sub_title;vars.sub_title=x;return chart};chart.text_format=function(x){if(!arguments.length)return vars.text_format;vars.text_format=x;return chart};chart.text_var=function(x){if(!arguments.length)return vars.text_var;vars.text_var=x;return chart};chart.tiles=function(x){if(!arguments.length)return vars.tiles;if(typeof x=="boolean")vars.tiles=x;else if(x==="false")vars.tiles=false;else vars.tiles=true;return chart};chart.title=function(x){if(!arguments.length)return vars.title;vars.title=x;return chart};chart.tooltip_info=function(x){if(!arguments.length)return vars.tooltip_info;vars.tooltip_info=x;return chart};chart.total_bar=function(x){if(!arguments.length)return vars.total_bar;vars.total_bar=x;return chart};chart.type=function(x){if(!arguments.length)return vars.type;vars.type=x;return chart};chart.value_var=function(x){if(!arguments.length)return vars.value_var;vars.value_var=x;return chart};chart.width=function(x){if(!arguments.length)return vars.svg_width;vars.svg_width=x;return chart};chart.xaxis_domain=function(x){if(!arguments.length)return vars.xaxis_domain;vars.xaxis_domain=x;return chart};chart.xaxis_var=function(x){if(!arguments.length)return vars.xaxis_var;vars.xaxis_var=x;return chart};chart.yaxis_domain=function(x){if(!arguments.length)return vars.yaxis_domain;vars.yaxis_domain=x;return chart};chart.yaxis_var=function(x){if(!arguments.length)return vars.yaxis_var;vars.yaxis_var=x;return chart};chart.year=function(x){if(!arguments.length)return vars.year;vars.year=x;return chart};chart.year_var=function(x){if(!arguments.length)return vars.year_var;vars.year_var=x;return chart};return chart};vizwhiz.network=function(vars){var dragging=false,highlight_color="#cc0000",secondary_color="#ffdddd",offset_top=0,offset_left=0,info_width=300,zoom_behavior=d3.behavior.zoom().scaleExtent([1,16]),scale={},hover=null,last_hover=null,last_highlight=null,highlight_extent={};var x_range=d3.extent(d3.values(vars.nodes),function(d){return d.x});var y_range=d3.extent(d3.values(vars.nodes),function(d){return d.y});var aspect=(x_range[1]-x_range[0])/(y_range[1]-y_range[0]);if(aspect>vars.width/vars.height){var viz_height=vars.width/aspect,viz_width=vars.width;offset_top=(vars.height-viz_height)/2}else{var viz_width=vars.height*aspect,viz_height=vars.height;offset_left=(vars.width-viz_width)/2}scale.x=d3.scale.linear().domain(x_range).range([offset_left,vars.width-offset_left]);scale.y=d3.scale.linear().domain(y_range).range([offset_top,vars.height-offset_top]);var val_range=d3.extent(d3.values(vars.data),function(d){return d[vars.value_var]?d[vars.value_var]:null});if(typeof val_range[0]=="undefined")val_range=[1,1];var distances=[];vars.nodes.forEach(function(n1){vars.nodes.forEach(function(n2){if(n1!=n2){var xx=Math.abs(scale.x(n1.x)-scale.x(n2.x));var yy=Math.abs(scale.y(n1.y)-scale.y(n2.y));distances.push(Math.sqrt(xx*xx+yy*yy))}})});var max_size=d3.min(distances);var min_size=2;scale.x.range([offset_left+max_size*1.5,vars.width-max_size*1.5-offset_left]);scale.y.range([offset_top+max_size*1.5,vars.height-max_size*1.5-offset_top]);scale.size=d3.scale.log().domain(val_range).range([min_size,max_size]);var viz_enter=vars.parent_enter.append("g").call(zoom_behavior.on("zoom",function(){zoom()})).on(vizwhiz.evt.down,function(d){dragging=true}).on(vizwhiz.evt.up,function(d){dragging=false}).append("g").attr("class","viz");viz_enter.append("rect").attr("class","overlay").attr("fill","#fff");d3.select("rect.overlay").attr("width",vars.width).attr("height",vars.height).on(vizwhiz.evt.over,function(d){if(!vars.highlight&&hover){hover=null;update()}}).on(vizwhiz.evt.click,function(d){vars.highlight=null;zoom("reset");update()}).on(vizwhiz.evt.move,function(d){if(zoom_behavior.scale()>1){d3.select(this).style("cursor","move");if(dragging){d3.select(this).style("cursor","-moz-grabbing");d3.select(this).style("cursor","-webkit-grabbing")}else{d3.select(this).style("cursor","-moz-grab");d3.select(this).style("cursor","-webkit-grab")}}else{d3.select(this).style("cursor","default")}});viz_enter.append("g").attr("class","links");viz_enter.append("g").attr("class","nodes");viz_enter.append("g").attr("class","highlight");viz_enter.append("g").attr("class","hover");if(!vars.small){vars.parent.select("div#zoom_controls").remove();var zoom_div=vars.parent.append("div").attr("id","zoom_controls").style("top",vars.margin.top+5+"px");zoom_div.append("div").attr("id","zoom_in").attr("unselectable","on").on(vizwhiz.evt.click,function(){zoom("in")}).text("+");zoom_div.append("div").attr("id","zoom_out").attr("unselectable","on").on(vizwhiz.evt.click,function(){zoom("out")}).text("-")}var node=d3.select("g.nodes").selectAll("circle.node").data(vars.nodes,function(d){return d[vars.id_var]});node.enter().append("circle").attr("class","node").attr("r",0).call(node_position).call(node_color).call(node_stroke);
var link=d3.select("g.links").selectAll("line.link").data(vars.links,function(d){return d.source[vars.id_var]+"-"+d.target[vars.id_var]});link.enter().append("line").attr("class","link").attr("pointer-events","none").attr("stroke","white").attr("stroke-width",1).call(link_position);node.on(vizwhiz.evt.over,function(d){hover=d[vars.id_var];update()});node.transition().duration(vizwhiz.timing).call(node_size).call(node_stroke).call(node_position).call(node_color);link.call(link_events);link.transition().duration(vizwhiz.timing).attr("stroke","#dedede").call(link_position);node.exit().transition().duration(vizwhiz.timing).attr("r",0).remove();link.exit().transition().duration(vizwhiz.timing).attr("stroke","white").remove();if(vars.highlight){var present=false;vars.nodes.forEach(function(d){if(d[vars.id_var]==vars.highlight)present=true});if(!present){vars.highlight=null}}update();function link_position(l){l.attr("x1",function(d){return scale.x(d.source.x)}).attr("y1",function(d){return scale.y(d.source.y)}).attr("x2",function(d){return scale.x(d.target.x)}).attr("y2",function(d){return scale.y(d.target.y)})}function link_events(l){l.on(vizwhiz.evt.click,function(d){vars.highlight=null;zoom("reset");update()})}function node_position(n){n.attr("cx",function(d){return scale.x(d.x)}).attr("cy",function(d){return scale.y(d.y)})}function node_size(n){n.attr("r",function(d){var value=find_variable(d[vars.id_var],vars.value_var);return value>0?scale.size(value):scale.size(val_range[0])})}function node_stroke(b){b.attr("stroke-width",function(d){var parent_group=this.parentNode.className.baseVal;var class_name=this.className.baseVal;var highlighted=parent_group=="hover_node";var bg=class_name=="bg";if(bg){if(vars.highlight==d[vars.id_var])return 3;else return 2}else if(highlighted)return 0;else return 1})}function node_color(n){n.attr("fill",function(d){var parent_group=this.parentNode.className.baseVal;var background_node=vars.highlight&&parent_group=="nodes";var highlighted=parent_group=="hover_node";var active=find_variable(d[vars.id_var],vars.active_var);var hidden=vars.spotlight&&!active;return(background_node||hidden)&&!highlighted?"#efefef":fill_color(d)}).attr("stroke",function(d){var parent_group=this.parentNode.className.baseVal;var background_node=vars.highlight&&parent_group=="nodes";var highlighted=parent_group=="hover_node";var active=find_variable(d[vars.id_var],vars.active_var);var hidden=vars.spotlight&&!active;if(highlighted)return fill_color(d);else if(background_node||hidden)return"#dedede";else return stroke_color(d)})}function fill_color(d){var color=find_variable(d[vars.id_var],"color");var active=find_variable(d[vars.id_var],vars.active_var);if(!active){var color=d3.hsl(color);color.l=.95}return color}function stroke_color(d){var color=find_variable(d[vars.id_var],"color");var active=find_variable(d[vars.id_var],vars.active_var);return active?"#333":color}function node_events(n){n.on(vizwhiz.evt.over,function(d){d3.select(this).style("cursor","pointer");d3.select(this).style("cursor","-moz-zoom-in");d3.select(this).style("cursor","-webkit-zoom-in");if(d[vars.id_var]==vars.highlight){d3.select(this).style("cursor","-moz-zoom-out");d3.select(this).style("cursor","-webkit-zoom-out")}if(d[vars.id_var]!=hover){hover=d[vars.id_var];update()}}).on(vizwhiz.evt.out,function(d){var target=d3.event.toElement;if(target){var id_check=target.__data__[vars.id_var]==d[vars.id_var];if(d3.event.toElement.parentNode!=this&&!id_check){hover=null;update()}}else{hover=null;update()}}).on(vizwhiz.evt.click,function(d){d3.select(this).style("cursor","auto");if(!vars.highlight||vars.highlight!=d[vars.id_var]){vars.highlight=d[vars.id_var]}else{vars.highlight=null}update()})}function update(){if(last_highlight!=vars.highlight){vizwhiz.tooltip.remove();d3.select("g.highlight").selectAll("*").remove();d3.select("g.hover").selectAll("*").remove();if(vars.highlight){create_nodes("highlight")}else{zoom("reset")}node.call(node_color);last_highlight=vars.highlight}if(last_hover!=hover){d3.select("g.hover").selectAll("*").remove();if(hover&&hover!=vars.highlight){create_nodes("hover")}last_hover=hover}function create_nodes(group){if(group=="highlight"){var c=vars.highlight}else{var c=hover}var node_data=vars.nodes.filter(function(x){return x[vars.id_var]==c});if(group=="highlight"||!vars.highlight){var prim_nodes=[],prim_links=[];if(vars.connections[c]){vars.connections[c].forEach(function(n){prim_nodes.push(vars.nodes.filter(function(x){return x[vars.id_var]==n[vars.id_var]})[0])});prim_nodes.forEach(function(n){prim_links.push({source:node_data[0],target:n})})}var node_data=prim_nodes.concat(node_data);highlight_extent.x=d3.extent(d3.values(node_data),function(v){return v.x}),highlight_extent.y=d3.extent(d3.values(node_data),function(v){return v.y});if(group=="highlight"){zoom(c);if(scale.x(highlight_extent.x[1])>vars.width-info_width-10){var x_pos=30}else{var x_pos=vars.width-info_width-5}var prod=vars.nodes.filter(function(n){return n[vars.id_var]==vars.highlight})[0];var tooltip_data=get_tooltip_data(vars.highlight);var tooltip_appends="<div class='vizwhiz_tooltip_footer'>Primary Connections</div>";prim_nodes.forEach(function(n){var parent="d3.select(&quot;#"+vars.parent.node().id+"&quot;)";tooltip_appends+="<div class='vizwhiz_network_connection' onclick='"+parent+".call(chart.highlight(&quot;"+n[vars.id_var]+"&quot;))'>";tooltip_appends+="<div class='vizwhiz_network_connection_node'";tooltip_appends+=" style='";tooltip_appends+="background-color:"+fill_color(n)+";";tooltip_appends+="border-color:"+stroke_color(n)+";";tooltip_appends+="'";tooltip_appends+="></div>";tooltip_appends+="<div class='vizwhiz_network_connection_name'>";tooltip_appends+=find_variable(n[vars.id_var],vars.text_var);tooltip_appends+="</div>";tooltip_appends+="</div>"});vizwhiz.tooltip.create({data:tooltip_data,title:find_variable(vars.highlight,vars.text_var),color:find_variable(vars.highlight,"color"),x:x_pos,y:vars.margin.top+5,width:info_width,html:tooltip_appends,fixed:true})}d3.select("g."+group).selectAll("line").data(prim_links).enter().append("line").attr("pointer-events","none").attr("stroke",highlight_color).attr("stroke-width",1.5).call(link_position)}var node_groups=d3.select("g."+group).selectAll("g").data(node_data).enter().append("g").attr("class","hover_node").call(node_events);node_groups.append("circle").attr("class","bg").call(node_size).call(node_position).call(node_stroke).attr("stroke",highlight_color);node_groups.append("circle").call(node_size).call(node_position).call(node_stroke).call(node_color).call(create_label)}}function create_label(n){if(vars.labels){n.each(function(d){var font_size=Math.ceil(10/zoom_behavior.scale()),value=find_variable(d[vars.id_var],vars.value_var),size=value>0?scale.size(value):scale.size(val_range[0]);if(font_size<size||d[vars.id_var]==hover||d[vars.id_var]==vars.highlight){d3.select(this.parentNode).append("text").attr("pointer-events","none").attr("x",scale.x(d.x)).attr("fill",vizwhiz.utils.text_color(fill_color(d))).attr("font-size",font_size+"px").attr("text-anchor","middle").attr("font-family","Helvetica").style("font-weight","bold").each(function(e){var tw=size*8,th=size<font_size*2?font_size*2:size;var text=find_variable(d[vars.id_var],vars.text_var);vizwhiz.utils.wordwrap({text:text,parent:this,width:tw,height:th,padding:0});if(!d3.select(this).select("tspan")[0][0]){d3.select(this).remove()}else{finish_label(d3.select(this))}})}function finish_label(text){var w=text.node().getBBox().width,h=text.node().getBBox().height;text.attr("y",scale.y(d.y)-h/2);if(h+font_size*1.5>size*2&&d[vars.id_var]!=hover&&d[vars.id_var]!=vars.highlight){text.remove()}else if(w+font_size>size*2){d3.select(text.node().parentNode).insert("rect","circle").attr("class","bg").attr("rx",font_size).attr("ry",font_size).attr("width",w+font_size*1.5).attr("height",h+font_size*1.5).attr("y",scale.y(d.y)-(h+font_size*1.5)/2).attr("x",scale.x(d.x)-(w+font_size*1.5)/2).call(node_stroke).attr("stroke",highlight_color);d3.select(text.node().parentNode).insert("rect","text").attr("rx",font_size).attr("ry",font_size).attr("stroke-width",0).attr("fill",fill_color(d)).attr("width",w+font_size*1.5).attr("height",h+font_size*1.5).attr("y",scale.y(d.y)-(h+font_size*1.5)/2).attr("x",scale.x(d.x)-(w+font_size*1.5)/2)}}})}}function zoom(direction){var zoom_extent=zoom_behavior.scaleExtent();if(!direction){evt_scale=d3.event.scale;translate=d3.event.translate}else{if(direction=="in"){if(zoom_behavior.scale()>zoom_extent[1]/2)multiplier=zoom_extent[1]/zoom_behavior.scale();else multiplier=2}else if(direction=="out"){if(zoom_behavior.scale()<zoom_extent[0]*2)multiplier=zoom_extent[0]/zoom_behavior.scale();else multiplier=.5}else if(direction==vars.highlight){var x_bounds=[scale.x(highlight_extent.x[0]),scale.x(highlight_extent.x[1])],y_bounds=[scale.y(highlight_extent.y[0]),scale.y(highlight_extent.y[1])];if(x_bounds[1]>vars.width-info_width-5)var offset_left=info_width+32;else var offset_left=0;var w_zoom=(vars.width-info_width-10)/(x_bounds[1]-x_bounds[0]),h_zoom=vars.height/(y_bounds[1]-y_bounds[0]);if(w_zoom<h_zoom){x_bounds=[x_bounds[0]-max_size*4,x_bounds[1]+max_size*4];evt_scale=(vars.width-info_width-10)/(x_bounds[1]-x_bounds[0]);if(evt_scale>zoom_extent[1])evt_scale=zoom_extent[1];offset_x=-(x_bounds[0]*evt_scale);offset_y=-(y_bounds[0]*evt_scale)+(vars.height-(y_bounds[1]-y_bounds[0])*evt_scale)/2}else{y_bounds=[y_bounds[0]-max_size*2,y_bounds[1]+max_size*2];evt_scale=vars.height/(y_bounds[1]-y_bounds[0]);if(evt_scale>zoom_extent[1])evt_scale=zoom_extent[1];offset_x=-(x_bounds[0]*evt_scale)+(vars.width-info_width-10-(x_bounds[1]-x_bounds[0])*evt_scale)/2;offset_y=-(y_bounds[0]*evt_scale)}translate=[offset_x+offset_left,offset_y]}else if(direction=="reset"){translate=[0,0];evt_scale=1}if(direction=="in"||direction=="out"){var trans=d3.select("g.viz")[0][0].getAttribute("transform");if(trans){trans=trans.split("(");var coords=trans[1].split(")");coords=coords[0].replace(" ",",");coords=coords.substring(0,trans[1].length-6).split(",");offset_x=parseFloat(coords[0]);offset_y=coords.length==2?parseFloat(coords[1]):parseFloat(coords[0]);zoom_var=parseFloat(trans[2].substring(0,trans[2].length-1))}else{offset_x=0;offset_y=0;zoom_var=1}if(multiplier>.5&&multiplier<=1&&direction=="out"){offset_x=0;offset_y=0}else{offset_x=vars.width/2-(vars.width/2-offset_x)*multiplier;offset_y=vars.height/2-(vars.height/2-offset_y)*multiplier}translate=[offset_x,offset_y];evt_scale=zoom_var*multiplier}}zoom_behavior.translate(translate).scale(evt_scale);if(translate[0]>0)translate[0]=0;else if(translate[0]<-(vars.width*evt_scale-vars.width)){translate[0]=-(vars.width*evt_scale-vars.width)}if(translate[1]>0)translate[1]=0;else if(translate[1]<-(vars.height*evt_scale-vars.height))translate[1]=-(vars.height*evt_scale-vars.height);if(!direction){if(d3.event.sourceEvent.type=="mousewheel"||d3.event.sourceEvent.type=="mousemove"){var viz_timing=d3.select(".viz")}else{var viz_timing=d3.select(".viz").transition().duration(vizwhiz.timing)}}else{var viz_timing=d3.select(".viz").transition().duration(vizwhiz.timing)}viz_timing.attr("transform","translate("+translate+")"+"scale("+evt_scale+")")}};vizwhiz.stacked=function(vars){var stack=d3.layout.stack().offset("zero").values(function(d){return d.values}).x(function(d){return parseInt(d.key)}).y(function(d){return d.values});var x_axis=d3.svg.axis().tickSize(0).tickPadding(15).orient("bottom").tickFormat(function(d,i){d3.select(this).attr("text-anchor","middle").style("font-weight","bold").attr("font-size","12px").attr("font-family","Helvetica").attr("fill","#4c4c4c");var bgtick=d3.select(this.parentNode).selectAll(".bgtick").data([i]);bgtick.enter().append("line").attr("class","bgtick").attr("x1",0).attr("x2",0).attr("y1",0-1).attr("y2",-graph.height+1).attr("stroke","#ccc").attr("stroke-width",1/2);bgtick.transition().duration(vizwhiz.timing).attr("y2",-graph.height+1);d3.select(this.parentNode).append("line").attr("class","tick_line").attr("x1",0).attr("x2",0).attr("y1",1).attr("y2",10).attr("stroke","#000").attr("stroke-width",1);return d});var y_axis=d3.svg.axis().tickSize(0).tickPadding(15).orient("left").tickFormat(function(d,i){d3.select(this).attr("text-anchor","middle").style("font-weight","bold").attr("font-size","12px").attr("font-family","Helvetica").attr("fill","#4c4c4c");var bgtick=d3.select(this.parentNode).selectAll(".bgtick").data([i]);bgtick.enter().append("line").attr("class","bgtick").attr("x1",0+1).attr("x2",0+graph.width-1).attr("y1",0).attr("y2",0).attr("stroke","#ccc").attr("stroke-width",1/2);bgtick.transition().duration(vizwhiz.timing).attr("x2",0+graph.width-1);d3.select(this.parentNode).append("line").attr("class","tick_line").attr("x1",-10).attr("x2",0-1).attr("y1",0).attr("y2",0).attr("stroke","#000").attr("stroke-width",1);if(vars.layout=="share"){return d3.format("p")(d)}return vizwhiz.utils.format_num(d,false,3,true)});if(vars.small){var graph_margin={top:0,right:0,bottom:0,left:0}}else{var graph_margin={top:10,right:40,bottom:80,left:90}}graph={width:vars.width-graph_margin.left-graph_margin.right,height:vars.height-graph_margin.top-graph_margin.bottom,x:graph_margin.left,y:graph_margin.top};xaxis_vals=vars.data.reduce(function(a,b){return a.concat(b[vars.xaxis_var])},[]).filter(function(value,index,self){return self.indexOf(value)===index});var xaxis_sums=d3.nest().key(function(d){return d[vars.xaxis_var]}).rollup(function(leaves){return d3.sum(leaves,function(d){return d[vars.value_var]})}).entries(vars.data);var data_max=vars.layout=="share"?1:d3.max(xaxis_sums,function(d){return d.values});nested_data=nest_data(xaxis_vals,vars.data,xaxis_sums);var x_scale=d3.scale.linear().domain([xaxis_vals[0],xaxis_vals[xaxis_vals.length-1]]).range([0,graph.width]);var y_scale=d3.scale.linear().domain([0,data_max]).range([graph.height,0]);var area=d3.svg.area().interpolate("monotone").x(function(d){return x_scale(parseInt(d.key))}).y0(function(d){return y_scale(d.y0)-1}).y1(function(d){return y_scale(d.y0+d.y)});var viz_enter=vars.parent_enter.append("g").attr("class","viz").attr("width",graph.width).attr("height",graph.height).attr("transform","translate("+graph.x+","+graph.y+")");viz_enter.append("rect").style("stroke","#000").style("stroke-width",1).style("fill","#efefef").attr("class","background").attr("x",0).attr("y",0).attr("opacity",0).attr("width",graph.width).attr("height",graph.height);d3.select(".viz").transition().duration(vizwhiz.timing).attr("width",graph.width).attr("height",graph.height).attr("transform","translate("+graph.x+","+graph.y+")").select(".viz rect").attr("opacity",1).attr("width",graph.width).attr("height",graph.height);var xaxis_enter=viz_enter.append("g").attr("class","xaxis").attr("transform","translate(0,"+graph.height+")").attr("opacity",0).call(x_axis.scale(x_scale));d3.select(".xaxis").transition().duration(vizwhiz.timing).attr("transform","translate(0,"+graph.height+")").attr("opacity",1).call(x_axis.scale(x_scale));xaxis_enter.append("text").attr("class","axis_title_x").attr("y",60).attr("text-anchor","middle").style("font-weight","bold").attr("font-size","14px").attr("font-family","Helvetica").attr("fill","#4c4c4c").attr("opacity",0).attr("width",graph.width).attr("x",graph.width/2);d3.select(".axis_title_x").transition().duration(vizwhiz.timing).attr("opacity",1).attr("width",graph.width).attr("x",graph.width/2).text(vars.text_format(vars.xaxis_var));var yaxis_enter=viz_enter.append("g").attr("class","yaxis").attr("opacity",0).call(y_axis.scale(y_scale));d3.select(".yaxis").transition().duration(vizwhiz.timing).attr("opacity",1).call(y_axis.scale(y_scale));d3.selectAll(".y_bg_line").attr("x2",graph.width);yaxis_enter.append("text").attr("class","axis_title_y").attr("text-anchor","middle").style("font-weight","bold").attr("font-size","14px").attr("font-family","Helvetica").attr("fill","#4c4c4c").attr("opacity",0).attr("width",graph.width).attr("transform","translate("+(graph.x-150)+","+(graph.y+graph.height/2)+") rotate(-90)");d3.select(".axis_title_y").transition().duration(vizwhiz.timing).attr("opacity",1).attr("width",graph.width).attr("transform","translate("+(graph.x-150)+","+(graph.y+graph.height/2)+") rotate(-90)").text(vars.text_format(vars.value_var));var offset=vars.layout=="value"?"zero":"expand";var layers=stack.offset(offset)(nested_data);viz_enter.append("g").attr("class","layers");var paths=d3.select("g.layers").selectAll(".layer").data(layers,function(d){return d.key});paths.enter().append("path").attr("opacity",0).attr("class","layer").attr("fill",function(d){return find_variable(d[vars.id_var],"color")}).attr("d",function(d){return area(d.values)});paths.on(vizwhiz.evt.move,path_tooltip).on(vizwhiz.evt.out,function(d){d3.selectAll("line.rule").remove();vizwhiz.tooltip.remove()});paths.transition().duration(vizwhiz.timing).attr("opacity",1).attr("fill",function(d){return find_variable(d[vars.id_var],"color")}).attr("d",function(d){return area(d.values)});function path_tooltip(d){d3.selectAll("line.rule").remove();var mouse_x=d3.event.layerX-graph_margin.left;var rev_x_scale=d3.scale.linear().domain(x_scale.range()).range(x_scale.domain());var this_x=Math.round(rev_x_scale(mouse_x));var this_x_index=xaxis_vals.indexOf(this_x);var this_value=d.values[this_x_index];d3.select("g.viz").append("line").datum(d).attr("class","rule").attr({x1:x_scale(this_x),x2:x_scale(this_x)}).attr({y1:y_scale(this_value.y0),y2:y_scale(this_value.y+this_value.y0)}).attr("stroke","white").attr("stroke-width",2).attr("stroke-opacity",.5).attr("stroke-dasharray","5,3").on(vizwhiz.evt.over,path_tooltip);var tooltip_data=get_tooltip_data(d[vars.id_var]);vizwhiz.tooltip.remove();vizwhiz.tooltip.create({data:tooltip_data,title:find_variable(d[vars.id_var],vars.text_var),id:d[vars.id_var],color:find_variable(d[vars.id_var],"color"),x:x_scale(this_x)+graph_margin.left+vars.margin.left+vars.parent.node().offsetLeft,y:y_scale(this_value.y0+this_value.y)+(graph.height-y_scale(this_value.y))/2+graph_margin.top+vars.margin.top+vars.parent.node().offsetTop,offset:(graph.height-y_scale(this_value.y))/2+2,arrow:true,mouseevents:false})}paths.exit().transition().duration(vizwhiz.timing).attr("opacity",0).remove();if(!vars.small){var defs=vars.parent_enter.append("svg:defs");vizwhiz.utils.drop_shadow(defs);var text_layers=[];var text_height_scale=d3.scale.linear().range([0,1]).domain([0,data_max]);layers.forEach(function(layer){var available_areas=layer.values.filter(function(d,i,a){var min_height=30;if(i==0){return graph.height-y_scale(d.y)>=min_height&&graph.height-y_scale(a[i+1].y)>=min_height&&graph.height-y_scale(a[i+2].y)>=min_height&&y_scale(d.y)-(graph.height-y_scale(d.y0))<y_scale(a[i+1].y0)&&y_scale(a[i+1].y)-(graph.height-y_scale(a[i+1].y0))<y_scale(a[i+2].y0)&&y_scale(d.y0)>y_scale(a[i+1].y)-(graph.height-y_scale(a[i+1].y0))&&y_scale(a[i+1].y0)>y_scale(a[i+2].y)-(graph.height-y_scale(a[i+2].y0))}else if(i==a.length-1){return graph.height-y_scale(d.y)>=min_height&&graph.height-y_scale(a[i-1].y)>=min_height&&graph.height-y_scale(a[i-2].y)>=min_height&&y_scale(d.y)-(graph.height-y_scale(d.y0))<y_scale(a[i-1].y0)&&y_scale(a[i-1].y)-(graph.height-y_scale(a[i-1].y0))<y_scale(a[i-2].y0)&&y_scale(d.y0)>y_scale(a[i-1].y)-(graph.height-y_scale(a[i-1].y0))&&y_scale(a[i-1].y0)>y_scale(a[i-2].y)-(graph.height-y_scale(a[i-2].y0))}else{return graph.height-y_scale(d.y)>=min_height&&graph.height-y_scale(a[i-1].y)>=min_height&&graph.height-y_scale(a[i+1].y)>=min_height&&y_scale(d.y)-(graph.height-y_scale(d.y0))<y_scale(a[i+1].y0)&&y_scale(d.y)-(graph.height-y_scale(d.y0))<y_scale(a[i-1].y0)&&y_scale(d.y0)>y_scale(a[i+1].y)-(graph.height-y_scale(a[i+1].y0))&&y_scale(d.y0)>y_scale(a[i-1].y)-(graph.height-y_scale(a[i-1].y0))}});var best_area=d3.max(layer.values,function(d,i){if(available_areas.indexOf(d)>=0){if(i==0){return graph.height-y_scale(d.y)+(graph.height-y_scale(layer.values[i+1].y))+(graph.height-y_scale(layer.values[i+2].y))}else if(i==layer.values.length-1){return graph.height-y_scale(d.y)+(graph.height-y_scale(layer.values[i-1].y))+(graph.height-y_scale(layer.values[i-2].y))}else{return graph.height-y_scale(d.y)+(graph.height-y_scale(layer.values[i-1].y))+(graph.height-y_scale(layer.values[i+1].y))}}else return null});var best_area=layer.values.filter(function(d,i,a){if(i==0){return graph.height-y_scale(d.y)+(graph.height-y_scale(layer.values[i+1].y))+(graph.height-y_scale(layer.values[i+2].y))==best_area}else if(i==layer.values.length-1){return graph.height-y_scale(d.y)+(graph.height-y_scale(layer.values[i-1].y))+(graph.height-y_scale(layer.values[i-2].y))==best_area}else{return graph.height-y_scale(d.y)+(graph.height-y_scale(layer.values[i-1].y))+(graph.height-y_scale(layer.values[i+1].y))==best_area}})[0];if(best_area){layer.tallest=best_area;text_layers.push(layer)}});viz_enter.append("g").attr("class","text_layers");var texts=d3.select("g.text_layers").selectAll(".label").data([]);texts.exit().remove();var texts=d3.select("g.text_layers").selectAll(".label").data(text_layers);texts.enter().append("text").attr("filter","url(#dropShadow)").attr("class","label").style("font-weight","bold").attr("font-size","14px").attr("font-family","Helvetica").attr("dy",6).attr("opacity",0).attr("text-anchor",function(d){if(d.tallest.key==x_scale.domain()[0])return"start";if(d.tallest.key==x_scale.domain()[1])return"end";return"middle"}).attr("fill",function(d){return"white"}).attr("x",function(d){var pad=0;if(d.tallest.key==x_scale.domain()[0])pad+=10;if(d.tallest.key==x_scale.domain()[1])pad-=10;return x_scale(d.tallest.key)+pad}).attr("y",function(d){var height=graph.height-y_scale(d.tallest.y);return y_scale(d.tallest.y0+d.tallest.y)+height/2}).text(function(d){return find_variable(d[vars.id_var],vars.text_var)}).on(vizwhiz.evt.over,path_tooltip).each(function(d){var tick_width=graph.width/xaxis_vals.length*2;if(this.getBBox().width>tick_width){d3.select(this).text("");var height=graph.height-y_scale(d.tallest.y);vizwhiz.utils.wordwrap({text:find_variable(d[vars.id_var],vars.text_var),parent:this,width:tick_width,height:height,resize:false});var offset=(height-this.getBBox().height)/2;var y_top=y_scale(d.tallest.y0+d.tallest.y);d3.select(this).attr("y",y_top+offset)}});texts.transition().duration(vizwhiz.timing).attr("opacity",1)}viz_enter.append("rect").style("stroke","#000").style("stroke-width",1*2).style("fill","none").attr("class","border").attr("width",graph.width).attr("height",graph.height).attr("x",0).attr("y",0).attr("opacity",0);d3.select(".border").transition().duration(vizwhiz.timing).attr("width",graph.width).attr("height",graph.height).attr("opacity",1);d3.select("rect.border").node().parentNode.appendChild(d3.select("rect.border").node());function nest_data(xaxis_vals,data,xaxis_sums){var info_lookup={};var nested=d3.nest().key(function(d){return d[vars.id_var]}).rollup(function(leaves){info_lookup[leaves[0][vars.id_var]]=JSON.parse(JSON.stringify(leaves[0]));delete info_lookup[leaves[0][vars.id_var]][vars.xaxis_var];delete info_lookup[leaves[0][vars.id_var]][vars.value_var];var values=d3.nest().key(function(d){return d[vars.xaxis_var]}).rollup(function(l){return d3.sum(l,function(d){return d[vars.value_var]})}).entries(leaves);xaxis_vars_available=values.reduce(function(a,b){return a.concat(b.key)},[]).filter(function(y,i,arr){return arr.indexOf(y)==i});xaxis_vals.forEach(function(y){if(xaxis_vars_available.indexOf(""+y)<0){values.push({key:""+y,values:0})}});return values.sort(function(a,b){return a.key-b.key})}).entries(vars.data);nested.forEach(function(d,i){d["total"]=d3.sum(d.values,function(dd){return dd.values});nested[i]=vizwhiz.utils.merge(d,info_lookup[d.key])});return nested.sort(function(a,b){if(a[vars.sort]<b[vars.sort])return vars.order=="desc"?-1:1;if(a[vars.sort]>b[vars.sort])return vars.order=="desc"?1:-1;return 0})}};vizwhiz.tree_map=function(vars){var tmap_data=d3.layout.treemap().round(false).size([vars.width,vars.height]).children(function(d){return d.children}).sort(function(a,b){return a.value-b.value}).value(function(d){return d[vars.value_var]}).nodes(vars.data).filter(function(d){return!d.children});var cell=d3.select("g.parent").selectAll("g").data(tmap_data,function(d){return d[vars.id_var]});var cell_enter=cell.enter().append("g").attr("opacity",0).attr("transform",function(d){return"translate("+d.x+","+d.y+")"});cell_enter.append("rect").attr("stroke","#ffffff").attr("width",function(d){return d.dx+"px"}).attr("height",function(d){return d.dy+"px"}).attr("fill",function(d){return find_variable(d[vars.id_var],"color")});cell_enter.append("text").attr("opacity",1).attr("text-anchor","start").style("font-weight","bold").attr("font-family","Helvetica").attr("class","name").attr("x","0.2em").attr("y","0em").attr("dy","1em").attr("fill",function(d){var color=find_variable(d[vars.id_var],"color");return vizwhiz.utils.text_color(color)}).style("pointer-events","none");cell_enter.append("text").attr("class","share").attr("text-anchor","middle").style("font-weight","bold").attr("font-family","Helvetica").attr("fill",function(d){var color=find_variable(d[vars.id_var],"color");return vizwhiz.utils.text_color(color)}).attr("fill-opacity",.5).style("pointer-events","none").text(function(d){var root=d;while(root.parent){root=root.parent}d.share=vizwhiz.utils.format_num(d.value/root.value,true,2);return d.share}).attr("font-size",function(d){var size=d.dx/7;if(d.dx<d.dy)var size=d.dx/7;else var size=d.dy/7;if(size<10)size=10;return size}).attr("x",function(d){return d.dx/2}).attr("y",function(d){return d.dy-parseInt(d3.select(this).attr("font-size"),10)*.1}).each(function(d){var el=d3.select(this).node().getBBox();if(d.dx<el.width)d3.select(this).remove();else if(d.dy<el.height)d3.select(this).remove()});cell.on(vizwhiz.evt.over,function(d){d3.select(this).style("cursor","pointer");vizwhiz.tooltip.remove();var tooltip_data=get_tooltip_data(d,"short");tooltip_data.push({name:vars.text_format("share"),value:d.share});var html=vars.click_function(d);var footer_text=html?vars.text_format("click box for more info"):null;vizwhiz.tooltip.create({title:find_variable(d[vars.id_var],vars.text_var),color:find_variable(d[vars.id_var],"color"),icon:find_variable(d[vars.id_var],"icon"),id:find_variable(d[vars.id_var],vars.id_var),x:d3.event.pageX,y:d3.event.pageY,offset:5,arrow:true,mouseevents:false,footer:footer_text,data:tooltip_data})}).on(vizwhiz.evt.move,function(d){vizwhiz.tooltip.move(d3.event.pageX,d3.event.pageY,d[vars.id_var])}).on(vizwhiz.evt.out,function(d){var target=d3.event.toElement;if(target){var class_name=typeof target.className=="object"?target.className.baseVal:target.className;if(class_name.indexOf("vizwhiz_tooltip")<0){vizwhiz.tooltip.remove(d[vars.id_var])}}else{vizwhiz.tooltip.remove(d[vars.id_var])}}).on(vizwhiz.evt.click,function(d){var html=vars.click_function(d);if(html){vizwhiz.tooltip.remove();var tooltip_data=get_tooltip_data(d,"long");tooltip_data.push({name:vars.text_format("share"),value:d.share});vizwhiz.tooltip.create({title:find_variable(d[vars.id_var],vars.text_var),color:find_variable(d[vars.id_var],"color"),icon:find_variable(d[vars.id_var],"icon"),id:find_variable(d[vars.id_var],vars.id_var),fullscreen:true,html:html,footer:vars.data_source,data:tooltip_data})}});cell.transition().duration(vizwhiz.timing).attr("transform",function(d){return"translate("+d.x+","+d.y+")"}).attr("opacity",1);cell.select("rect").transition().duration(vizwhiz.timing).attr("width",function(d){return d.dx+"px"}).attr("height",function(d){return d.dy+"px"});cell.select("text.name").transition().duration(vizwhiz.timing/2).attr("opacity",0).transition().duration(vizwhiz.timing/2).each("end",function(d){d3.select(this).selectAll("tspan").remove();var id=d[vars.id_var];var name=find_variable(id,vars.text_var);if(name&&d.dx>30&&d.dy>30){var text=[];if(vars.name_array){vars.name_array.forEach(function(n){var name=find_variable(id,n);if(name)text.push(vars.text_format(name))})}else{if(name)text.push(name);if(id)text.push(id)}vizwhiz.utils.wordwrap({text:text,parent:this,width:d.dx,height:d.dy,resize:true})}d3.select(this).transition().duration(vizwhiz.timing/2).attr("opacity",1)});cell.select("text.share").transition().duration(vizwhiz.timing/2).attr("opacity",0).each("end",function(d){d3.select(this).text(function(d){var root=d.parent;while(root.parent){root=root.parent}d.share=vizwhiz.utils.format_num(d.value/root.value,true,2);return d.share}).attr("font-size",function(d){var size=d.dx/7;if(d.dx<d.dy)var size=d.dx/7;else var size=d.dy/7;if(size<10)size=10;return size}).attr("x",function(d){return d.dx/2}).attr("y",function(d){return d.dy-parseInt(d3.select(this).attr("font-size"),10)*.1}).each(function(d){var el=d3.select(this).node().getBBox();if(d.dx<el.width)d3.select(this).remove();else if(d.dy<el.height)d3.select(this).remove()});d3.select(this).transition().duration(vizwhiz.timing/2).attr("opacity",1)});cell.exit().transition().duration(vizwhiz.timing).attr("opacity",0).remove()};vizwhiz.geo_map=function(vars){if(vars.init){vars.projection.scale(vars.width/(2*Math.PI)).translate([vars.width/2,vars.height/2]);vars.zoom_behavior.scale(vars.projection.scale()*2*Math.PI).translate(vars.projection.translate()).on("zoom",function(d){zoom(d)}).scaleExtent([vars.width,1<<23])}var default_opacity=.25,select_opacity=.75,stroke_width=1,color_gradient=["#00008f","#003fff","#00efff","#ffdf00","#ff3000","#7f0000"],dragging=false,info_width=vars.small?0:300,scale_height=10,scale_padding=20,path=d3.geo.path().projection(vars.projection),tile=d3.geo.tile().size([vars.width,vars.height]),old_scale=vars.projection.scale()*2*Math.PI,old_translate=vars.projection.translate(),hover=null;if(vars.data){data_extent=d3.extent(d3.values(vars.data),function(d){return d[vars.value_var]&&d[vars.value_var]!=0?d[vars.value_var]:null});var data_range=[],step=0;while(step<=1){data_range.push(data_extent[0]*Math.pow(data_extent[1]/data_extent[0],step));step+=.2}var value_color=d3.scale.log().domain(data_range).interpolate(d3.interpolateRgb).range(color_gradient)}var defs=vars.parent_enter.append("defs");if(vars.map.coords){vars.parent_enter.append("rect").attr("id","water").attr("width",vars.width).attr("height",vars.height).attr(vars.map.style.water);d3.select("#water").transition().duration(vizwhiz.timing).attr("width",vars.width).attr("height",vars.height);vars.parent_enter.append("g").attr("id","land").attr("class","viz");var land=d3.select("g#land").selectAll("path").data(topojson.object(vars.map.coords,vars.map.coords.objects[Object.keys(vars.map.coords.objects)[0]]).geometries);land.enter().append("path").attr("d",path).attr(vars.map.style.land)}vars.parent_enter.append("g").attr("class","tiles");if(vars.tiles)update_tiles(0);else d3.selectAll("g.tiles *").remove();var viz_enter=vars.parent_enter.append("g").call(vars.zoom_behavior).on(vizwhiz.evt.down,function(d){dragging=true}).on(vizwhiz.evt.up,function(d){dragging=false}).append("g").attr("class","viz");viz_enter.append("rect").attr("class","overlay").attr("width",vars.width).attr("height",vars.height).attr("fill","transparent");d3.select("rect.overlay").on(vizwhiz.evt.click,function(d){if(vars.highlight){var temp=vars.highlight;vars.highlight=null;d3.select("#path"+temp).call(color_paths);zoom(vars.boundries);info()}});viz_enter.append("g").attr("class","paths");if(!vars.small){var gradient=defs.append("svg:linearGradient").attr("id","gradient").attr("x1","0%").attr("y1","0%").attr("x2","100%").attr("y2","0%").attr("spreadMethod","pad");data_range.forEach(function(v,i){gradient.append("stop").attr("offset",Math.round(i/(data_range.length-1)*100)+"%").attr("stop-color",value_color(v)).attr("stop-opacity",1)});var scale=vars.parent_enter.append("g").attr("class","scale").style("opacity",0).attr("transform","translate("+(vars.width-info_width-5)+","+5+")");scale.append("rect").attr("width",info_width+"px").attr("height",scale_height*6+"px").attr("fill","#ffffff").attr("rx",3).attr("ry",3).attr("stroke","#888").attr("stroke-width",1);
scale.append("text").attr("id","scale_title").attr("x",info_width/2+"px").attr("y","0px").attr("dy","1.25em").attr("text-anchor","middle").attr("fill","#333").style("font-weight","bold").attr("font-size","12px").attr("font-family","Helvetica");data_range.forEach(function(v,i){if(i==data_range.length-1){var x=scale_padding+Math.round(i/(data_range.length-1)*(info_width-scale_padding*2))-1}else if(i!=0){var x=scale_padding+Math.round(i/(data_range.length-1)*(info_width-scale_padding*2))-1}else{var x=scale_padding+Math.round(i/(data_range.length-1)*(info_width-scale_padding*2))}scale.append("rect").attr("x",x+"px").attr("y",scale_height*2.5+"px").attr("width",1).attr("height",scale_height*1.5+"px").style("fill","#333");scale.append("rect").attr("x",scale_padding+"px").attr("y",scale_height*2.5+"px").attr("width",info_width-scale_padding*2+"px").attr("height",scale_height+"px").style("fill","url(#gradient)");scale.append("text").attr("id","scale_"+i).attr("x",x+"px").attr("y",scale_height*3.5+5+"px").attr("dy","1em").attr("text-anchor","middle").attr("fill","#333").style("font-weight","normal").attr("font-size","10px").attr("font-family","Helvetica")});if(!data_extent[0]){d3.select("g.scale").style("opacity",0)}else{data_range.forEach(function(v,i){scale.select("text#scale_"+i).text(vars.number_format(v))});scale.select("text#scale_title").text(vars.text_format(vars.value_var));d3.select("g.scale").style("opacity",1)}vars.parent.select("div#zoom_controls").remove();var zoom_div=vars.parent.append("div").attr("id","zoom_controls").style("top",function(){return this.offsetTop+vars.margin.top+"px"});zoom_div.append("div").attr("id","zoom_in").attr("unselectable","on").on(vizwhiz.evt.click,function(){zoom("in")}).text("+");zoom_div.append("div").attr("id","zoom_out").attr("unselectable","on").on(vizwhiz.evt.click,function(){zoom("out")}).text("-")}var coord=d3.select("g.paths").selectAll("path").data(vars.coords);coord.enter().append("path").attr("id",function(d){return"path"+d.id}).attr("d",path).attr("vector-effect","non-scaling-stroke").attr("opacity",0);coord.on(vizwhiz.evt.over,function(d){hover=d[vars.id_var];if(vars.highlight!=d[vars.id_var]){d3.select(this).attr("opacity",select_opacity)}if(!vars.highlight){info()}}).on(vizwhiz.evt.out,function(d){hover=null;if(vars.highlight!=d[vars.id_var]){d3.select(this).attr("opacity",default_opacity)}if(!vars.highlight){info()}}).on(vizwhiz.evt.click,function(d){if(vars.highlight==d[vars.id_var]){vars.highlight=null;d3.select(this).call(color_paths);zoom(vars.boundries)}else{if(vars.highlight){var temp=vars.highlight;vars.highlight=null;d3.select("path#path"+temp).call(color_paths)}vars.highlight=d[vars.id_var];d3.select(this).call(color_paths);zoom(d3.select(this).datum())}info()});coord.transition().duration(vizwhiz.timing).attr("opacity",default_opacity).call(color_paths);info();d3.select("g.scale").transition().duration(vizwhiz.timing).attr("transform","translate("+(vars.width-info_width-5)+","+5+")");if(vars.init){zoom(vars.boundries,0);vars.init=false}if(vars.highlight){zoom(d3.select("path#path"+vars.highlight).datum())}function color_paths(p){defs.selectAll("#stroke_clip").remove();p.attr("fill",function(d){if(d[vars.id_var]==vars.highlight)return"none";else if(!vars.data[d[vars.id_var]])return"#888888";else return vars.data[d[vars.id_var]][vars.value_var]?value_color(vars.data[d[vars.id_var]][vars.value_var]):"#888888"}).attr("stroke-width",function(d){if(d[vars.id_var]==vars.highlight)return 10;else return stroke_width}).attr("stroke",function(d){if(d[vars.id_var]==vars.highlight){if(!vars.data[d[vars.id_var]])return"#888";return vars.data[d[vars.id_var]][vars.value_var]?value_color(vars.data[d[vars.id_var]][vars.value_var]):"#888888"}else return"white"}).attr("opacity",function(d){if(d[vars.id_var]==vars.highlight)return select_opacity;else return default_opacity}).attr("clip-path",function(d){if(d[vars.id_var]==vars.highlight)return"url(#stroke_clip)";else return"none"}).each(function(d){if(d[vars.id_var]==vars.highlight){d3.select("defs").append("clipPath").attr("id","stroke_clip").append("use").attr("xlink:href",function(dd){return"#path"+vars.highlight})}})}function zoom(param,custom_timing){var translate=vars.zoom_behavior.translate(),zoom_extent=vars.zoom_behavior.scaleExtent();var scale=vars.zoom_behavior.scale();if(param=="in")var scale=scale*2;else if(param=="out")var scale=scale*.5;var svg_scale=scale/vars.width,svg_translate=[translate[0]-scale/2,translate[1]-scale/vars.width*vars.height/2];old_scale=vars.projection.scale()*2*Math.PI;old_translate=vars.projection.translate();if(param.coordinates){if(vars.highlight){var left=20,w_avail=vars.width-info_width-left}else{var left=0,w_avail=vars.width}var b=path.bounds(param),w=(b[1][0]-b[0][0])*1.1,h=(b[1][1]-b[0][1])*1.1,s_width=w_avail*(scale/vars.width)/w,s_height=vars.height*(scale/vars.width)/h;if(s_width<s_height){var s=s_width*vars.width,offset_left=(w_avail-w/1.1/svg_scale*s/vars.width)/2+left,offset_top=(vars.height-h/svg_scale*s/vars.width)/2}else{var s=s_height*vars.width,offset_left=(w_avail-w/svg_scale*s/vars.width)/2+left,offset_top=(vars.height-h/1.1/svg_scale*s/vars.width)/2}var t_x=-(b[0][0]-svg_translate[0])/svg_scale*s/vars.width+offset_left,t_y=-(b[0][1]-svg_translate[1])/svg_scale*s/vars.width+offset_top;var t=[t_x+s/2,t_y+s/vars.width*vars.height/2];translate=t;scale=s}else if(param=="in"||param=="out"){var b=vars.projection.translate();if(param=="in")translate=[b[0]+(b[0]-vars.width/2),b[1]+(b[1]-vars.height/2)];else if(param=="out")translate=[b[0]+(vars.width/2-b[0])/2,b[1]+(vars.height/2-b[1])/2]}if(scale<zoom_extent[0])scale=zoom_extent[0];else if(scale>zoom_extent[1])scale=zoom_extent[1];if(translate[0]>scale/2)translate[0]=scale/2;else if(translate[0]<vars.width-scale/2)translate[0]=vars.width-scale/2;if(translate[1]>scale/2)translate[1]=scale/2;else if(translate[1]<vars.height-scale/2)translate[1]=vars.height-scale/2;vars.projection.scale(scale/(2*Math.PI)).translate(translate);vars.zoom_behavior.scale(scale).translate(translate);svg_scale=scale/vars.width;svg_translate=[translate[0]-scale/2,translate[1]-scale/vars.width*vars.height/2];if(typeof custom_timing!="number"){if(d3.event){if(d3.event.scale){if(d3.event.sourceEvent.type=="mousewheel"||d3.event.sourceEvent.type=="mousemove"){var zoom_timing=0}else{var zoom_timing=vizwhiz.timing}}else{var zoom_timing=vizwhiz.timing}}else{var zoom_timing=vizwhiz.timing*4}}else var zoom_timing=custom_timing;if(vars.tiles)update_tiles(zoom_timing);if(zoom_timing>0)var viz_transition=d3.selectAll(".viz").transition().duration(zoom_timing);else var viz_transition=d3.selectAll(".viz");viz_transition.attr("transform","translate("+svg_translate+")"+"scale("+svg_scale+")")}function info(){vizwhiz.tooltip.remove();if(!vars.small&&(hover||vars.highlight)){var tooltip_data=get_tooltip_data(vars.highlight);var id=vars.highlight?vars.highlight:hover;var data=vars.data[id];if(data&&data[vars.value_var]){var color=value_color(data[vars.value_var])}else{var color="#888"}if(!data||!data[vars.value_var]){var footer=vars.text_format("No Data Available")}else if(!vars.highlight){var footer=vars.text_format("Click for More Info")}else{var footer=vars.data_source}vizwhiz.tooltip.create({data:tooltip_data,title:find_variable(id,vars.text_var),id:find_variable(id,vars.id_var),icon:find_variable(id,"icon"),color:color,footer:footer,x:vars.width-info_width-5+vars.margin.left+vars.parent.node().offsetLeft,y:scale_height*6+10+vars.margin.top+vars.parent.node().offsetTop,fixed:true,width:info_width})}}function tileUrl(d){return"http://"+["a","b","c"][Math.random()*3|0]+".tile.cloudmade.com/c3cf91e1455249adaef26d096785dc90/88261/256/"+d[2]+"/"+d[0]+"/"+d[1]+".png"}function update_tiles(image_timing){var t=vars.projection.translate(),s=vars.projection.scale()*2*Math.PI;var tiles=tile.scale(s).translate(t)(),old_tiles=tile.scale(old_scale).translate(old_translate)();var image=d3.select("g.tiles").selectAll("image.tile").data(tiles,function(d){return d});image.enter().append("image").attr("class","tile").attr("xlink:href",tileUrl).attr("opacity",0).attr("width",Math.ceil(tiles.scale/(s/old_scale))).attr("height",Math.ceil(tiles.scale/(s/old_scale))).attr("x",function(d){var test=-(t[0]-s/(old_scale/old_translate[0]));return Math.ceil((d[0]+tiles.translate[0])*tiles.scale+test)/(s/old_scale)}).attr("y",function(d){var test=-(t[1]-s/(old_scale/old_translate[1]));return Math.ceil((d[1]+tiles.translate[1])*tiles.scale+test)/(s/old_scale)});if(image_timing>0)var image_transition=image.transition().duration(image_timing);else var image_transition=image;image_transition.attr("opacity",1).attr("width",Math.ceil(tiles.scale)).attr("height",Math.ceil(tiles.scale)).attr("x",function(d){return Math.ceil((d[0]+tiles.translate[0])*tiles.scale)}).attr("y",function(d){return Math.ceil((d[1]+tiles.translate[1])*tiles.scale)});image.exit().remove()}};vizwhiz.pie_scatter=function(vars){var x_axis=d3.svg.axis().tickSize(0).tickPadding(25).orient("bottom").tickFormat(function(d,i){d3.select(this).attr("text-anchor","middle").style("font-weight","bold").attr("font-size","12px").attr("font-family","Helvetica").attr("fill","#4c4c4c");var bgtick=d3.select(this.parentNode).selectAll(".bgtick").data([i]);bgtick.enter().append("line").attr("class","bgtick").attr("x1",0).attr("x2",0).attr("y1",0-1).attr("y2",-graph.height+1).attr("stroke","#ccc").attr("stroke-width",1);bgtick.transition().duration(vizwhiz.timing).attr("y2",-graph.height+1);d3.select(this.parentNode).append("line").attr("class","tick_line").attr("x1",0).attr("x2",0).attr("y1",1).attr("y2",20).attr("stroke","#000").attr("stroke-width",1);return vizwhiz.utils.format_num(d,false,3,true)});var y_axis=d3.svg.axis().tickSize(0).tickPadding(25).orient("left").tickFormat(function(d,i){d3.select(this).attr("text-anchor","middle").style("font-weight","bold").attr("font-size","12px").attr("font-family","Helvetica").attr("fill","#4c4c4c");var bgtick=d3.select(this.parentNode).selectAll(".bgtick").data([i]);bgtick.enter().append("line").attr("class","bgtick").attr("x1",0+1).attr("x2",0+graph.width-1).attr("y1",0).attr("y2",0).attr("stroke","#ccc").attr("stroke-width",1);bgtick.transition().duration(vizwhiz.timing).attr("x2",0+graph.width-1);d3.select(this.parentNode).append("line").attr("class","tick_line").attr("x1",-20).attr("x2",0).attr("y1",0).attr("y2",0).attr("stroke","#4c4c4c").attr("stroke-width",1);return vizwhiz.utils.format_num(d,false,3,true)});if(vars.small){var graph_margin={top:0,right:0,bottom:0,left:0}}else{var graph_margin={top:10,right:40,bottom:80,left:90}}graph={width:vars.width-graph_margin.left-graph_margin.right,height:vars.height-graph_margin.top-graph_margin.bottom,x:graph_margin.left,y:graph_margin.top};var viz_enter=vars.parent_enter.append("g").attr("class","viz").attr("transform","translate("+graph.x+","+graph.y+")");viz_enter.append("rect").style("stroke","#000").style("stroke-width",1).style("fill","#efefef").attr("class","background").attr("x",0).attr("y",0).attr("width",graph.width).attr("height",graph.height);d3.select(".viz").transition().duration(vizwhiz.timing).attr("transform","translate("+graph.x+","+graph.y+")").select("rect").attr("width",graph.width).attr("height",graph.height);var data_range=d3.extent(vars.data,function(d){return d[vars.value_var]==0?null:d[vars.value_var]});if(!data_range[1])data_range=[0,0];var size_scale=d3.scale.log().domain(data_range).range([2,d3.max([d3.min([vars.width,vars.height])/35,10])]).nice();if(vars.xaxis_domain.length<2)var x_domain=d3.extent(vars.data,function(d){return d[vars.xaxis_var]});else var x_domain=vars.xaxis_domain;var x_scale=d3.scale.linear().domain(x_domain).range([0,graph.width]).nice();var inverse_x_scale=d3.scale.linear().domain(x_scale.range()).range(x_scale.domain());var largest_size=size_scale.range()[1];largest_size=inverse_x_scale(largest_size);var x_buffer=largest_size-x_scale.domain()[0];x_scale.domain([x_scale.domain()[0]-x_buffer,x_scale.domain()[1]+x_buffer]);var xaxis_enter=viz_enter.append("g").attr("transform","translate(0,"+graph.height+")").attr("class","xaxis").call(x_axis.scale(x_scale));d3.select(".xaxis").transition().duration(vizwhiz.timing).attr("transform","translate(0,"+graph.height+")").call(x_axis.scale(x_scale));d3.selectAll(".x_bg_line").attr("y2",-graph.height-1);xaxis_enter.append("text").attr("y",60).attr("class","axis_title_x").attr("text-anchor","middle").style("font-weight","bold").attr("font-size","14px").attr("font-family","Helvetica").attr("fill","#4c4c4c").attr("width",graph.width).attr("x",graph.width/2);d3.select(".axis_title_x").transition().duration(vizwhiz.timing).attr("width",graph.width).attr("x",graph.width/2).text(vars.text_format(vars.xaxis_var));if(vars.yaxis_domain.length<2)var y_domain=d3.extent(vars.data,function(d){return d[vars.yaxis_var]}).reverse();else var y_domain=vars.yaxis_domain;var y_scale=d3.scale.linear().domain(y_domain).range([0,graph.height]).nice();var inverse_y_scale=d3.scale.linear().domain(y_scale.range()).range(y_scale.domain());largest_size=size_scale.range()[1];largest_size=inverse_y_scale(largest_size);var y_buffer=largest_size-y_scale.domain()[0];y_scale.domain([y_scale.domain()[0]-y_buffer,y_scale.domain()[1]+y_buffer]);var yaxis_enter=viz_enter.append("g").attr("class","yaxis").call(y_axis.scale(y_scale));d3.select(".yaxis").transition().duration(vizwhiz.timing).call(y_axis.scale(y_scale));d3.selectAll(".y_bg_line").attr("x2",0+graph.width-1);yaxis_enter.append("text").attr("class","axis_title_y").attr("text-anchor","middle").style("font-weight","bold").attr("font-size","14px").attr("font-family","Helvetica").attr("fill","#4c4c4c").attr("width",graph.width).attr("transform","translate("+(graph.x-150)+","+(graph.y+graph.height/2)+") rotate(-90)");d3.select(".axis_title_y").transition().duration(vizwhiz.timing).attr("width",graph.width).attr("transform","translate("+(graph.x-150)+","+(graph.y+graph.height/2)+") rotate(-90)").text(vars.text_format(vars.yaxis_var));var arc=d3.svg.arc().innerRadius(0).startAngle(0).outerRadius(function(d){return d.arc_radius}).endAngle(function(d){return d.arc_angle});vars.data.sort(function(node_a,node_b){return node_b[vars.value_var]-node_a[vars.value_var]});var nodes=d3.select("g.viz").selectAll("g.circle").data(vars.data,function(d){return d[vars.id_var]});nodes.enter().append("g").attr("opacity",0).attr("class","circle").attr("transform",function(d){return"translate("+x_scale(d[vars.xaxis_var])+","+y_scale(d[vars.yaxis_var])+")"}).each(function(d){d3.select(this).append("circle").style("stroke",function(dd){if(d.active||d.num_children_active==d.num_children&&d.active!=false){return"#333"}else{return find_variable(d[vars.id_var],"color")}}).style("stroke-width",1).style("fill",function(dd){if(d.active||d.num_children_active==d.num_children&&d.active!=false){return find_variable(d[vars.id_var],"color")}else{var c=d3.hsl(find_variable(d[vars.id_var],"color"));c.l=.95;return c.toString()}}).attr("r",0);vars.arc_angles[d.id]=0;vars.arc_sizes[d.id]=0;d3.select(this).append("path").style("fill",find_variable(d[vars.id_var],"color")).style("fill-opacity",1);d3.select(this).select("path").transition().duration(vizwhiz.timing).attrTween("d",arcTween)});nodes.on(vizwhiz.evt.over,hover(x_scale,y_scale,size_scale,graph)).on(vizwhiz.evt.out,function(){vizwhiz.tooltip.remove();d3.selectAll(".axis_hover").remove()});nodes.transition().duration(vizwhiz.timing).attr("transform",function(d){return"translate("+x_scale(d[vars.xaxis_var])+","+y_scale(d[vars.yaxis_var])+")"}).attr("opacity",1).each(function(d){var val=d[vars.value_var];val=val&&val>0?val:size_scale.domain()[0];d.arc_radius=size_scale(val);d3.select(this).select("circle").transition().duration(vizwhiz.timing).style("stroke",function(dd){if(d.active||d.num_children_active==d.num_children&&d.active!=false)return"#333";else return find_variable(d[vars.id_var],"color")}).style("fill",function(dd){if(d.active||d.num_children_active==d.num_children&&d.active!=false)return find_variable(d[vars.id_var],"color");else{var c=d3.hsl(find_variable(d[vars.id_var],"color"));c.l=.95;return c.toString()}}).attr("r",d.arc_radius);if(d.num_children){d.arc_angle=d.num_children_active/d.num_children*360*(Math.PI/180);d3.select(this).select("path").transition().duration(vizwhiz.timing).attrTween("d",arcTween).each("end",function(dd){vars.arc_angles[d.id]=d.arc_angle;vars.arc_sizes[d.id]=d.arc_radius})}});nodes.exit().transition().duration(vizwhiz.timing).attr("opacity",0).remove();var ticks=d3.select("g.viz").selectAll("g.ticks").data(vars.data,function(d){return d[vars.id_var]});var ticks_enter=ticks.enter().append("g").attr("class","ticks");ticks_enter.append("line").attr("class","yticks").attr("x1",-10).attr("x2",0).attr("y1",function(d){return y_scale(d[vars.yaxis_var])}).attr("y2",function(d){return y_scale(d[vars.yaxis_var])}).attr("stroke",function(d){return find_variable(d[vars.id_var],"color")}).attr("stroke-width",1);ticks.selectAll(".yticks").transition().duration(vizwhiz.timing).attr("x1",-10).attr("x2",0).attr("y1",function(d){return y_scale(d[vars.yaxis_var])}).attr("y2",function(d){return y_scale(d[vars.yaxis_var])});ticks_enter.append("line").attr("class","xticks").attr("y1",graph.height).attr("y2",graph.height+10).attr("x1",function(d){return x_scale(d[vars.xaxis_var])}).attr("x2",function(d){return x_scale(d[vars.xaxis_var])}).attr("stroke",function(d){return find_variable(d[vars.id_var],"color")}).attr("stroke-width",1);ticks.selectAll(".xticks").transition().duration(vizwhiz.timing).attr("y1",graph.height).attr("y2",graph.height+10).attr("x1",function(d){return x_scale(d[vars.xaxis_var])}).attr("x2",function(d){return x_scale(d[vars.xaxis_var])});ticks.exit().remove();viz_enter.append("rect").style("stroke","#000").style("stroke-width",1*2).style("fill","none").attr("class","border").attr("width",graph.width).attr("height",graph.height).attr("x",0).attr("y",0);d3.select(".border").transition().duration(vizwhiz.timing).attr("width",graph.width).attr("height",graph.height);d3.select("rect.border").node().parentNode.appendChild(d3.select("rect.border").node());function arcTween(b){var i=d3.interpolate({arc_angle:vars.arc_angles[b.id],arc_radius:vars.arc_sizes[b.id]},b);return function(t){return arc(i(t))}}function hover(x_scale,y_scale,size_scale,xsize){return function(d){var val=d[vars.value_var]?d[vars.value_var]:size_scale.domain()[0];var radius=size_scale(val),x=x_scale(d[vars.xaxis_var]),y=y_scale(d[vars.yaxis_var]),color=d.active||d.num_children_active/d.num_children==1?"#333":find_variable(d[vars.id_var],"color"),viz=d3.select("g.viz");viz.append("line").attr("class","axis_hover").attr("x1",x).attr("x2",x).attr("y1",y+radius+1).attr("y2",graph.height).attr("stroke",color).attr("stroke-width",2);viz.append("line").attr("class","axis_hover").attr("x1",0).attr("x2",x-radius).attr("y1",y).attr("y2",y).attr("stroke",color).attr("stroke-width",2);viz.append("rect").attr("class","axis_hover").attr("x",x-25).attr("y",graph.height).attr("width",50).attr("height",20).attr("fill","white").attr("stroke",color).attr("stroke-width",2);viz.append("text").attr("class","axis_hover").attr("x",x).attr("y",graph.height).attr("dy",14).attr("text-anchor","middle").style("font-weight","bold").attr("font-size","12px").attr("font-family","Helvetica").attr("fill","#4c4c4c").text(vizwhiz.utils.format_num(d[vars.xaxis_var],false,3,true));viz.append("rect").attr("class","axis_hover").attr("x",-50).attr("y",y-10).attr("width",50).attr("height",20).attr("fill","white").attr("stroke",color).attr("stroke-width",2);viz.append("text").attr("class","axis_hover").attr("x",-25).attr("y",y-10).attr("dy",14).attr("text-anchor","middle").style("font-weight","bold").attr("font-size","12px").attr("font-family","Helvetica").attr("fill","#4c4c4c").text(vizwhiz.utils.format_num(d[vars.yaxis_var],false,3,true));var tooltip_data=get_tooltip_data(d);vizwhiz.tooltip.create({id:d[vars.id_var],color:find_variable(d[vars.id_var],"color"),icon:find_variable(d[vars.id_var],"icon"),data:tooltip_data,title:find_variable(d[vars.id_var],vars.text_var),x:x+graph.x+vars.margin.left+vars.parent.node().offsetLeft,y:y+graph.y+vars.margin.top+vars.parent.node().offsetTop,offset:radius,arrow:true,footer:vars.data_source,mouseevents:false})}}};vizwhiz.bubbles=function(vars){var groups={},donut_size=.35,title_height=vars.small?0:30,arc_offset=vars.donut?donut_size:0,sort_order=vars.sort=="value"?vars.value_var:vars.sort;var arc=d3.svg.arc().startAngle(0).innerRadius(function(d){return d.arc_inner}).outerRadius(function(d){return d.arc_radius}).endAngle(function(d){return d.arc_angle});var arc_else=d3.svg.arc().startAngle(0).innerRadius(function(d){return d.arc_inner_else}).outerRadius(function(d){return d.arc_radius_else}).endAngle(function(d){return d.arc_angle_else});var arc_bg=d3.svg.arc().startAngle(0).innerRadius(function(d){return d.arc_inner_bg}).outerRadius(function(d){return d.arc_radius_bg}).endAngle(360);var data_nested={};data_nested.key="root";data_nested.values=d3.nest().key(function(d){return d[vars.grouping]}).entries(vars.data);var pack=d3.layout.pack().size([vars.width,vars.height]).children(function(d){return d.values}).padding(5).value(function(d){return d[vars.value_var]}).sort(function(a,b){if(a.values&&b.values)return a.values.length-b.values.length;else return a[vars.value_var]-b[vars.value_var]});var data_packed=pack.nodes(data_nested).filter(function(d){if(d.depth==1){if(d.children.length==1){d[vars.text_var]=find_variable(d.children[0][vars.id_var],vars.text_var);d.category=d.children[0].category}else{d[vars.text_var]=d.key;d.category=d.key}d[vars.value_var]=d.value}return d.depth==1}).sort(function(a,b){if(typeof a[sort_order]=="number"){if(a[sort_order]<b[sort_order])return 1;if(a[sort_order]>b[sort_order])return-1}else{if(a[sort_order]<b[sort_order])return-1;if(a[sort_order]>b[sort_order])return 1}return 0});if(data_packed.length==1){var columns=1,rows=1}else if(data_packed.length<4){var columns=data_packed.length,rows=1}else{var rows=Math.ceil(Math.sqrt(data_packed.length/(vars.width/vars.height))),columns=Math.ceil(Math.sqrt(data_packed.length*(vars.width/vars.height)))}while((rows-1)*columns>=data_packed.length)rows--;var max_size=d3.max(data_packed,function(d){return d.r})*2,downscale=d3.min([vars.width/columns,vars.height/rows-title_height])*.9/max_size;var r=0,c=0;data_packed.forEach(function(d){if(d.depth==1){if(vars.grouping!="active"){var color=find_variable(d.children[0][vars.id_var],"color")}else{var color="#cccccc"}color=d3.rgb(color).hsl();if(color.s>.9)color.s=.75;while(color.l>.75)color=color.darker();color=color.rgb();groups[d.key]={};groups[d.key].color=color;groups[d.key].children=d.children.length;groups[d.key].key=d.key;groups[d.key][vars.text_var]=d[vars.text_var];groups[d.key].x=vars.width/columns*c+vars.width/columns/2;groups[d.key].y=vars.height/rows*r+vars.height/rows/2+title_height/2;groups[d.key].width=vars.width/columns;groups[d.key].height=vars.height/rows;groups[d.key].r=d.r*downscale;if(c<columns-1)c++;else{c=0;r++}}});vars.data.forEach(function(d){var parent=data_packed.filter(function(p){if(d[vars.grouping]===false)var key="false";else if(d[vars.grouping]===true)var key="true";else var key=d[vars.grouping];return key==p.key})[0];d.x=downscale*(d.x-parent.x)+groups[parent.key].x;d.y=downscale*(d.y-parent.y)+groups[parent.key].y;d.r=d.r*downscale});vars.parent_enter.append("g").attr("class","groups");vars.parent_enter.append("g").attr("class","bubbles");vars.parent_enter.append("g").attr("class","labels");if(vars.small)groups={};var group=d3.select("g.groups").selectAll("g.group").data(d3.values(groups),function(d){return d.key});group.enter().append("g").attr("class","group").attr("transform",function(d){return"translate("+d.x+","+d.y+")"}).each(function(d){if(vars.grouping=="active"){var t=d[vars.text_var]=="true"?"Fully "+vars.active_var:"Not Fully "+vars.active_var}else{var t=d[vars.text_var]}d3.select(this).append("text").attr("opacity",0).attr("text-anchor","middle").attr("font-weight","bold").attr("font-size","12px").attr("font-family","Helvetica").attr("fill",d.color).attr("x",0).attr("y",function(dd){return-(d.height/2)-title_height/4}).each(function(){vizwhiz.utils.wordwrap({text:t,parent:this,width:d.width,height:30})})});group.transition().duration(vizwhiz.timing).attr("transform",function(d){return"translate("+d.x+","+d.y+")"}).each(function(d){if(vars.group_bgs&&d.children>1){var bg=d3.select(this).selectAll("circle").data([d]);bg.enter().append("circle").attr("fill",d.color).attr("stroke",d.color).attr("stroke-width",1).style("fill-opacity",.1).attr("opacity",0).attr("r",d.r);bg.transition().duration(vizwhiz.timing).attr("opacity",1).attr("r",d.r)}else{d3.select(this).select("circle").transition().duration(vizwhiz.timing).attr("opacity",0).remove()}d3.select(this).select("text").transition().duration(vizwhiz.timing).attr("opacity",1).attr("y",function(dd){return-(d.height/2)-title_height/4})});group.exit().transition().duration(vizwhiz.timing).each(function(d){if(vars.group_bgs){d3.select(this).select("circle").transition().duration(vizwhiz.timing).attr("r",0).attr("opacity",0)}d3.select(this).selectAll("text").transition().duration(vizwhiz.timing).attr("opacity",0)}).remove();var bubble=d3.select("g.bubbles").selectAll("g.bubble").data(vars.data,function(d){return d[vars.id_var]});bubble.enter().append("g").attr("class","bubble").attr("transform",function(d){return"translate("+d.x+","+d.y+")"}).each(function(d){vars.arc_sizes[d[vars.id_var]+"_bg"]=0;vars.arc_inners[d[vars.id_var]+"_bg"]=0;var color=find_variable(d[vars.id_var],"color");var bg_color=d3.hsl(color);bg_color.l=.95;bg_color=bg_color.toString();d3.select(this).append("path").attr("class","bg").attr("fill",bg_color).attr("stroke",color).attr("stroke-width",1);d3.select(this).select("path.bg").transition().duration(vizwhiz.timing).attrTween("d",arcTween_bg);if(d.elsewhere){vars.arc_angles[d[vars.id_var]+"_else"]=0;vars.arc_sizes[d[vars.id_var]+"_else"]=0;vars.arc_inners[d[vars.id_var]+"_else"]=0;d3.select(this).append("path").attr("class","elsewhere").style("fill",color).style("fill-opacity",.5);d3.select(this).select("path.elsewhere").transition().duration(vizwhiz.timing).attrTween("d",arcTween_else)}vars.arc_angles[d[vars.id_var]]=0;vars.arc_sizes[d[vars.id_var]]=0;vars.arc_inners[d[vars.id_var]]=0;d3.select(this).append("path").each(function(dd){dd.arc_id=dd[vars.id_var]}).attr("class","available").style("fill",color);d3.select(this).select("path.available").transition().duration(vizwhiz.timing).attrTween("d",arcTween)}).transition().duration(vizwhiz.timing).each(function(d){if(vars.donut)d.arc_inner_bg=d.r*arc_offset;else d.arc_inner_bg=0;d.arc_radius_bg=d.r;d3.select(this).select("path.bg").transition().duration(vizwhiz.timing).attrTween("d",arcTween_bg).each("end",function(){vars.arc_sizes[d[vars.id_var]+"_bg"]=d.arc_radius_bg;vars.arc_inners[d[vars.id_var]+"_bg"]=d.arc_inner_bg});var arc_start=d.r*arc_offset;d.arc_inner=arc_start;d.arc_radius=arc_start+(d.r-arc_start);d3.select(this).select("path.available").transition().duration(vizwhiz.timing).attrTween("d",arcTween).each("end",function(){vars.arc_sizes[d[vars.id_var]]=d.arc_radius;vars.arc_inners[d[vars.id_var]]=d.arc_inner;if(d.total)d.arc_angle=d[vars.active_var]/d.total*360*(Math.PI/180);else if(d.active)d.arc_angle=Math.PI;d.arc_angle=d.arc_angle<Math.PI*2?d.arc_angle:Math.PI*2;d3.select(this).transition().duration(vizwhiz.timing*(d.arc_angle/2)).attrTween("d",arcTween).each("end",function(){vars.arc_angles[d[vars.id_var]]=d.arc_angle})});if(d.elsewhere){d.arc_inner_else=arc_start;d.arc_radius_else=d.r;d3.select(this).select("path.elsewhere").transition().duration(vizwhiz.timing).attrTween("d",arcTween_else).each("end",function(){vars.arc_sizes[d[vars.id_var]+"_else"]=d.arc_radius_else;vars.arc_inners[d[vars.id_var]+"_else"]=d.arc_inner_else;d.arc_angle_else=d.arc_angle+d.elsewhere/d.total*360*(Math.PI/180);d.arc_angle_else=d.arc_angle_else<Math.PI*2?d.arc_angle_else:Math.PI*2;d3.select(this).transition().duration(vizwhiz.timing*(d.arc_angle_else/2)).attrTween("d",arcTween_else).each("end",function(){vars.arc_angles[d[vars.id_var]+"_else"]=d.arc_angle_else})})}});bubble.on(vizwhiz.evt.over,function(d){var tooltip_data=get_tooltip_data(d[vars.id_var]);vizwhiz.tooltip.create({id:d[vars.id_var],color:find_variable(d[vars.id_var],"color"),icon:find_variable(d[vars.id_var],"icon"),data:tooltip_data,title:find_variable(d[vars.id_var],vars.text_var),x:d.x+vars.margin.left+vars.parent.node().offsetLeft,y:d.y+vars.margin.top+vars.parent.node().offsetTop,offset:d.r,arrow:true,mouseevents:false})}).on(vizwhiz.evt.out,function(d){vizwhiz.tooltip.remove()});bubble.transition().duration(vizwhiz.timing).attr("transform",function(d){return"translate("+d.x+","+d.y+")"}).each("end",function(d){if(vars.donut)d.arc_inner_bg=d.r*arc_offset;else d.arc_inner_bg=0;d.arc_radius_bg=d.r;d3.select(this).select("path.bg").transition().duration(vizwhiz.timing).attrTween("d",arcTween_bg).each("end",function(){vars.arc_sizes[d[vars.id_var]+"_bg"]=d.arc_radius_bg;vars.arc_inners[d[vars.id_var]+"_bg"]=d.arc_inner_bg});var arc_start=d.r*arc_offset;d.arc_inner=arc_start;d.arc_radius=arc_start+(d.r-arc_start);if(d.total)d.arc_angle=d[vars.active_var]/d.total*360*(Math.PI/180);else if(d.active)d.arc_angle=Math.PI;d.arc_angle=d.arc_angle<Math.PI*2?d.arc_angle:Math.PI*2;d3.select(this).select("path.available").transition().duration(vizwhiz.timing).attrTween("d",arcTween).each("end",function(){vars.arc_sizes[d[vars.id_var]]=d.arc_radius;vars.arc_inners[d[vars.id_var]]=d.arc_inner;vars.arc_angles[d[vars.id_var]]=d.arc_angle});if(d.elsewhere){d.arc_inner_else=arc_start;d.arc_radius_else=d.r;d.arc_angle_else=d.arc_angle+d.elsewhere/d.total*360*(Math.PI/180);d.arc_angle_else=d.arc_angle_else<Math.PI*2?d.arc_angle_else:Math.PI*2;d3.select(this).select("path.elsewhere").transition().duration(vizwhiz.timing).attrTween("d",arcTween_else).each("end",function(){vars.arc_sizes[d[vars.id_var]+"_else"]=d.arc_radius_else;vars.arc_inners[d[vars.id_var]+"_else"]=d.arc_inner_else;vars.arc_angles[d[vars.id_var]+"_else"]=d.arc_angle_else})}});bubble.exit().transition().duration(vizwhiz.timing).each(function(d){d.arc_radius_bg=0;d.arc_inner_bg=0;d3.select(this).select("path.bg").transition().duration(vizwhiz.timing).attrTween("d",arcTween_bg).each("end",function(){vars.arc_sizes[d[vars.id_var]+"_bg"]=d.arc_radius_bg;vars.arc_inners[d[vars.id_var]+"_bg"]=d.arc_inner_bg});d.arc_radius=0;d.arc_angle=0;d.arc_inner=0;d3.select(this).select("path.available").transition().duration(vizwhiz.timing).attrTween("d",arcTween).each("end",function(){vars.arc_angles[d[vars.id_var]]=d.arc_angle;vars.arc_sizes[d[vars.id_var]]=d.arc_radius;vars.arc_inners[d[vars.id_var]]=d.arc_inner});if(d.elsewhere){d.arc_angle_else=0;d.arc_radius_else=0;d.arc_inner_else=0;d3.select(this).select("path.elsewhere").transition().duration(vizwhiz.timing).attrTween("d",arcTween_else).each("end",function(dd){vars.arc_angles[d[vars.id_var]+"_else"]=d.arc_angle_else;vars.arc_sizes[d[vars.id_var]+"_else"]=d.arc_radius_else;vars.arc_inners[d[vars.id_var]+"_else"]=d.arc_inner_else})}d3.select(this).select("circle.hole").transition().duration(vizwhiz.timing).attr("r",0)}).remove();function arcTween(b){var i=d3.interpolate({arc_angle:vars.arc_angles[b[vars.id_var]],arc_radius:vars.arc_sizes[b[vars.id_var]],arc_inner:vars.arc_inners[b[vars.id_var]]},b);return function(t){return arc(i(t))}}function arcTween_else(b){var i=d3.interpolate({arc_angle_else:vars.arc_angles[b[vars.id_var]+"_else"],arc_radius_else:vars.arc_sizes[b[vars.id_var]+"_else"],arc_inner_else:vars.arc_inners[b[vars.id_var]+"_else"]},b);return function(t){return arc_else(i(t))}}function arcTween_bg(b){var i=d3.interpolate({arc_radius_bg:vars.arc_sizes[b[vars.id_var]+"_bg"],arc_inner_bg:vars.arc_inners[b[vars.id_var]+"_bg"]},b);
return function(t){return arc_bg(i(t))}}};vizwhiz.rings=function(vars){var tooltip_width=200;var width=vars.small?vars.width:vars.width-tooltip_width;var tree_radius=vars.height>width?width/2:vars.height/2,node_size=d3.scale.linear().domain([1,2]).range([8,4]),ring_width=vars.small?tree_radius/2.25:tree_radius/3,total_children,hover=null;var viz_enter=vars.parent_enter.append("g").attr("class","viz").attr("transform","translate("+width/2+","+vars.height/2+")");viz_enter.append("g").attr("class","links");viz_enter.append("g").attr("class","nodes");d3.select("g.viz").transition().duration(vizwhiz.timing).attr("transform","translate("+width/2+","+vars.height/2+")");var tree=d3.layout.tree().size([360,tree_radius-ring_width]).separation(function(a,b){return(a.parent==b.parent?1:2)/a.depth});var diagonal=d3.svg.diagonal.radial().projection(function(d){return[d.y,d.x/180*Math.PI]});var line=d3.svg.line().x(function(d){return d.x}).y(function(d){return d.y}).interpolate("basis");var root=get_root();var tree_nodes=root.nodes,tree_links=root.links;var link=d3.select(".links").selectAll(".link").data([]);link.exit().remove();var link=d3.select(".links").selectAll(".link").data(tree_links);link.enter().append("path").attr("fill","none").attr("class","link").attr("opacity",0).call(line_styles);link.transition().duration(vizwhiz.timing).attr("opacity",1).attr("d",function(d){if(d.source[vars.id_var]==vars.highlight){var x=d.target.ring_y*Math.cos((d.target.ring_x-90)*(Math.PI/180)),y=d.target.ring_y*Math.sin((d.target.ring_x-90)*(Math.PI/180));return line([{x:0,y:0},{x:x,y:y}])}else{var x1=d.source.ring_x,y1=d.source.ring_y,x2=d.target.ring_x,y2=d.target.ring_y;return diagonal({source:{x:x1,y:y1},target:{x:x2,y:y2}})}}).call(line_styles);link.exit().transition().duration(vizwhiz.timing).attr("opacity",0).remove();var node=d3.select(".nodes").selectAll(".node").data([]);node.exit().remove();var node=d3.select(".nodes").selectAll(".node").data(tree_nodes);var node_enter=node.enter().append("g").attr("class","node").attr("opacity",0).attr("transform",function(d){if(d.depth==0)return"none";else return"rotate("+(d.ring_x-90)+")translate("+0+")"});node_enter.append("circle").attr("id",function(d){return"node_"+d[vars.id_var]}).attr("r",0).call(circle_styles);if(!vars.small){node_enter.append("text").attr("font-weight","bold").attr("font-size","10px").attr("font-family","Helvetica").call(text_styles)}node.on(vizwhiz.evt.over,function(d){if(d.depth!=0){d3.select(this).style("cursor","pointer");d3.select(this).style("cursor","-moz-zoom-in");d3.select(this).style("cursor","-webkit-zoom-in");hover=d;if(!vars.small){link.call(line_styles);d3.selectAll(".node circle").call(circle_styles);d3.selectAll(".node text").call(text_styles)}}}).on(vizwhiz.evt.out,function(d){if(d.depth!=0){hover=null;if(!vars.small){link.call(line_styles);d3.selectAll(".node circle").call(circle_styles);d3.selectAll(".node text").call(text_styles)}}}).on(vizwhiz.evt.click,function(d){if(d.depth!=0)vars.parent.call(chart.highlight(d[vars.id_var]))});node.transition().duration(vizwhiz.timing).attr("opacity",1).attr("transform",function(d){if(d.depth==0)return"none";else return"rotate("+(d.ring_x-90)+")translate("+d.ring_y+")"});node.select("circle").transition().duration(vizwhiz.timing).attr("r",function(d){if(d.depth==0)return ring_width/2;var s=node_size(d.depth);if(d.depth==1)var limit=Math.PI*(tree_radius-ring_width*2)*2/total_children;if(d.depth==2)var limit=Math.PI*(tree_radius-ring_width)*2/total_children;if(s>limit/2)s=limit/2;if(s<2)s=2;d.radius=s;return d.radius}).call(circle_styles);node.select("text").attr("text-anchor",function(d){if(d.depth==0)return"middle";else return d.ring_x%360<180?"start":"end"}).attr("transform",function(d){if(d.depth==0)return"none";else{var offset=d.radius*2;return d.ring_x%360<180?"translate("+offset+")":"rotate(180)translate(-"+offset+")"}}).attr("transform",function(d){if(d.depth==0)return"none";else{var offset=d.radius*2;return d.ring_x%360<180?"translate("+offset+")":"rotate(180)translate(-"+offset+")"}}).each(function(d){if(d.depth==0)var s=Math.sqrt(ring_width*ring_width/2),w=s*1.5,h=s/1.5,resize=true;else{var w=ring_width-d.radius*2,resize=false;if(d.depth==1)var h=Math.PI*(tree_radius-ring_width*2)*2*(d.size/360);if(d.depth==2)var h=Math.PI*(tree_radius-ring_width)*2/total_children}if(h<15)h=15;vizwhiz.utils.wordwrap({text:d.name,parent:this,width:w,height:h,resize:resize,font_min:6});d3.select(this).attr("y",-d3.select(this).node().getBBox().height/2+"px");d3.select(this).selectAll("tspan").attr("x",0)}).call(text_styles);node.exit().transition().duration(vizwhiz.timing).attr("opacity",0).remove();hover=null;if(!vars.small){vizwhiz.tooltip.remove();var html=vars.click_function(vars.data[vars.highlight]);var tooltip_data=get_tooltip_data(vars.highlight);vizwhiz.tooltip.remove();vizwhiz.tooltip.create({title:find_variable(vars.highlight,vars.text_var),color:find_variable(vars.highlight,"color"),icon:find_variable(vars.highlight,"icon"),id:vars.highlight,html:html,footer:vars.data_source,data:tooltip_data,x:vars.width-5,y:vars.margin.top+5,align:"top right",width:tooltip_width})}function line_styles(l){l.attr("stroke",function(d){if(hover){if(d.source==hover||d.target==hover||hover.depth==2&&hover.parents.indexOf(d.target)>=0){this.parentNode.appendChild(this);return"#cc0000"}else if(hover.depth==1&&hover.children_total.indexOf(d.target)>=0){return"#ffbbbb"}else return"#ddd"}else return"#ddd"}).attr("stroke-width","1.5").attr("opacity",function(d){if(hover&&d3.select(this).attr("stroke")=="#ddd"){return.25}return.75})}function circle_styles(c){c.attr("fill",function(d){if(find_variable(d[vars.id_var],vars.active_var)){var color=d.color}else{var lighter_col=d3.hsl(d.color);lighter_col.l=.95;var color=lighter_col.toString()}if(d.depth==0)return color;else if(d.depth==1&&(!hover||d==hover||d.children_total.indexOf(hover)>=0))return color;else if(d.depth==2&&(!hover||d==hover||d.parents.indexOf(hover)>=0))return color;else return"lightgrey"}).attr("stroke",function(d){if(find_variable(d[vars.id_var],vars.active_var)){var color="#333"}else{var color=vizwhiz.utils.darker_color(d.color)}if(d.depth==0)return color;else if(d.depth==1&&(!hover||d==hover||d.children_total.indexOf(hover)>=0))return color;else if(d.depth==2&&(!hover||d==hover||d.parents.indexOf(hover)>=0))return color;else return"darkgrey"}).attr("stroke-width","1")}function text_styles(t){t.attr("fill",function(d){if(d.depth==0){var color=vizwhiz.utils.text_color(d3.select("circle#node_"+d[vars.id_var]).attr("fill"))}else{var color=vizwhiz.utils.darker_color(d.color)}if(d.depth==0)return color;else if(d.depth==1&&(!hover||d==hover||d.children_total.indexOf(hover)>=0))return color;else if(d.depth==2&&(!hover||d==hover||d.parents.indexOf(hover)>=0))return color;else return"lightgrey"})}function get_root(){var links=[],nodes=[],root={};root.ring_x=0;root.ring_y=0;root.depth=0;root[vars.text_var]=find_variable(vars.highlight,vars.text_var);root[vars.id_var]=vars.highlight;root.children=[];root.color=find_variable(vars.highlight,"color");root[vars.active_var]=find_variable(vars.highlight,vars.active_var);nodes.push(root);var prim_links=vars.connections[vars.highlight];if(prim_links){prim_links.forEach(function(child){child.ring_x=0;child.ring_y=ring_width;child.depth=1;child[vars.text_var]=find_variable(child[vars.id_var],vars.text_var);child.children=[];child.children_total=[];child.color=find_variable(child[vars.id_var],"color");child[vars.active_var]=find_variable(child[vars.id_var],vars.active_var);nodes.push(child);root.children.push(child);links.push({source:nodes[nodes.indexOf(root)],target:nodes[nodes.indexOf(child)]});vars.connections[child[vars.id_var]].forEach(function(grandchild){child.children_total.push(grandchild)})});var len=nodes.length,len2=nodes.length;while(len--){var sec_links=vars.connections[nodes[len][vars.id_var]];if(sec_links){sec_links.forEach(function(grandchild){if(prim_links.indexOf(grandchild)<0&&grandchild[vars.id_var]!=vars.highlight){grandchild.ring_x=0;grandchild.ring_y=ring_width*2;grandchild.depth=2;grandchild[vars.text_var]=find_variable(grandchild[vars.id_var],vars.text_var);grandchild.color=find_variable(grandchild[vars.id_var],"color");grandchild[vars.active_var]=find_variable(grandchild[vars.id_var],vars.active_var);grandchild.parents=[];var s=1e4,node_id=0;prim_links.forEach(function(node){var temp_links=vars.connections[node[vars.id_var]];temp_links.forEach(function(node2){if(node2[vars.id_var]==grandchild[vars.id_var]){grandchild.parents.push(node);if(temp_links.length<s){s=temp_links.length;node_id=node[vars.id_var]}}})});var len3=len2;while(len3--){if(nodes[len3][vars.id_var]==node_id&&nodes[len3].children.indexOf(grandchild)<0){nodes[len3].children.push(grandchild)}}if(nodes.indexOf(grandchild)<0){nodes.push(grandchild)}links.push({source:nodes[len],target:nodes[nodes.indexOf(grandchild)]})}})}}}var first_offset=0;total_children=d3.sum(nodes,function(dd){if(dd.depth==1){if(dd.children.length>0)return dd.children.length;else return 1}else return 0});nodes[0].children.sort(function(a,b){var a_color=d3.rgb(a.color).hsl().h;var b_color=d3.rgb(b.color).hsl().h;if(d3.rgb(a.color).hsl().s==0)a_color=361;if(d3.rgb(b.color).hsl().s==0)b_color=361;if(a_color<b_color)return-1;if(a_color>b_color)return 1;return 0});nodes[0].children.forEach(function(d){if(d.children.length>1)var num=d.children.length;else var num=1;d.ring_x=(first_offset+num/2)/total_children*360;d.size=num/total_children*360;if(d.size>180)d.size=180;var positions=num/2;d.children.sort(function(a,b){var a_color=d3.rgb(a.color).hsl().h;var b_color=d3.rgb(b.color).hsl().h;if(d3.rgb(a.color).hsl().s==0)a_color=361;if(d3.rgb(b.color).hsl().s==0)b_color=361;if(a_color<b_color)return-1;if(a_color>b_color)return 1;return 0});d.children.forEach(function(c,i){if(d.children.length<=1)c.ring_x=d.ring_x;else c.ring_x=d.ring_x+(i+.5-positions)/positions*(d.size/2)});first_offset+=num});return{nodes:nodes,links:links}}}})();